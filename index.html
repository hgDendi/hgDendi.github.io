<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="HgWorts">
<meta property="og:url" content="http://www.hgworts.tech/index.html">
<meta property="og:site_name" content="HgWorts">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HgWorts">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.hgworts.tech/"/>





  <title>HgWorts</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HgWorts</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Think big thoughts , but relish small pleasures.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hgworts.tech/2017/11/13/如何上传自己的Android库到JCenter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hgDendi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HgWorts">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/13/如何上传自己的Android库到JCenter/" itemprop="url">如何上传自己的Android库到JCenter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-13T00:00:00+08:00">
                2017-11-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>介绍如何将自己的项目上传到JCenter。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们经常在Android的gradle文件中看到这些compile脚本，这些脚本其实就是因为之前库的开发者把对应库的jar或aar文件放到了远程服务器上，所以我们可以通过compile进行拉取。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">'com.android.support:recyclerview-v7:27.0.0'</span></span><br><span class="line">compile <span class="string">'com.squareup:otto:1.3.7'</span></span><br><span class="line">compile <span class="string">'com.squareup.picasso:picasso:2.5.2'</span></span><br><span class="line">compile <span class="string">'com.squareup.okhttp:okhttp:2.4.0'</span></span><br><span class="line">compile <span class="string">'com.squareup.retrofit:retrofit:1.9.0'</span></span><br></pre></td></tr></table></figure>
<h3 id="AAR是什么"><a href="#AAR是什么" class="headerlink" title="AAR是什么"></a>AAR是什么</h3><p>因为AndroidLibrary一般需要内置一些Android特定文件，比如Manifest，Resources，Assets或者JNI等超出jar文件标准的格式。</p>
<p>jar包是被嵌入在aar文件包中的一部分。</p>
<h3 id="排布规则"><a href="#排布规则" class="headerlink" title="排布规则"></a>排布规则</h3><p>compile后面的字符串排布规则是</p>
<p>GROUP_ID:ARTIFACT_ID:VERSION</p>
<h4 id="GROUP-ID"><a href="#GROUP-ID" class="headerlink" title="GROUP_ID"></a>GROUP_ID</h4><p>通常用开发者的包名进行命名。</p>
<p>很有可能同一个上下文中有好几个library，这些可以共享同一个GROUP_ID</p>
<h4 id="ARTIFACT-ID"><a href="#ARTIFACT-ID" class="headerlink" title="ARTIFACT_ID"></a>ARTIFACT_ID</h4><p>定义library的真实名字，比如picasso</p>
<h4 id="VERSION"><a href="#VERSION" class="headerlink" title="VERSION"></a>VERSION</h4><p>版本号，一般是x.x.x格式</p>
<h2 id="Android项目准备"><a href="#Android项目准备" class="headerlink" title="Android项目准备"></a>Android项目准备</h2><p>以一个简单的demo为例，项目地址在</p>
<p><a href="https://github.com/hgDendi/AndroidJCenterDemo" target="_blank" rel="noopener">https://github.com/hgDendi/AndroidJCenterDemo</a></p>
<p>是一个HelloWorld项目，其中字符串来自于mylib module下的MyLib抽象类的静态方法。</p>
<p>mylib也是我们这次需要上传到JCenter的类。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1flfkm0i210j31f2104n53.jpg" alt="project"></p>
<h3 id="Module划分"><a href="#Module划分" class="headerlink" title="Module划分"></a>Module划分</h3><p>一般需要把需要上传的库作为一个独立的module，即1 module per 1 library。</p>
<p>一般分为库的模块和使用demo模块。</p>
<p>如果想要有一个以上的库，请划分多个module。</p>
<p>比如如下的项目结构。<img src="https://ws2.sinaimg.cn/large/006tKfTcgy1flfj850vuxj30n20lmwgx.jpg" alt="1510486146328"></p>
<h3 id="bintray"><a href="#bintray" class="headerlink" title="bintray"></a>bintray</h3><p>注册账号，登录bintray.com。</p>
<h4 id="新建仓库"><a href="#新建仓库" class="headerlink" title="新建仓库"></a>新建仓库</h4><p>在个人管理界面点击“Add New Repository”</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1flfj872g3ej30pq0a4wfb.jpg" alt="1510486324520"></p>
<p>然后创建一个Maven仓库</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1flfj86ad46j314g1jgn1w.jpg" alt="1510486374030"></p>
<p>创建成功之后点击”Create New Package”</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1flfj85onarj31j40my774.jpg" alt="WX20171112-193514@2x"></p>
<p>输入对应信息，其中Website和VersionControl可以填写github地址，issue填写github的issue地址</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1flfk8n6qqyj31hu1hc0z4.jpg" alt="WX20171112-193746@2x"></p>
<p>点击CreatePackage，你在Bintray上的Maven服务器就已经创建成功了。</p>
<h3 id="项目文件准备"><a href="#项目文件准备" class="headerlink" title="项目文件准备"></a>项目文件准备</h3><h4 id="Project-gradle"><a href="#Project-gradle" class="headerlink" title="Project#gradle"></a>Project#gradle</h4><p>在Project的gradle文件中加入依赖</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">'com.android.tools.build:gradle:3.0.0'</span></span><br><span class="line">        classpath <span class="string">'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.6'</span></span><br><span class="line">        classpath <span class="string">'com.github.dcendents:android-maven-gradle-plugin:1.4.1'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="local-properties"><a href="#local-properties" class="headerlink" title="local.properties"></a>local.properties</h4><p>在local.properties中加入用户信息。</p>
<p>因为gitignore自动忽略local.properties，所以私人信息放在这里是比较安全的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bintray.user=[...]</span><br><span class="line">bintray.apikey=[...]</span><br><span class="line">bintray.gpg.password=[...]</span><br></pre></td></tr></table></figure>
<p>apikey可以在EditProfile里看到</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1flfk8oyqi2j31i60sqgpx.jpg" alt="APIKEY"></p>
<h4 id="module的build-gradle"><a href="#module的build-gradle" class="headerlink" title="module的build.gradle"></a>module的build.gradle</h4><p>根据上面步骤中的信息，在lib module的build.gradle文件中增加信息。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.library'</span></span><br><span class="line"></span><br><span class="line">ext &#123;</span><br><span class="line">  	<span class="comment">// 刚刚创建的仓库名</span></span><br><span class="line">    bintrayRepo = <span class="string">'testMaven'</span></span><br><span class="line">  	<span class="comment">// package的名字</span></span><br><span class="line">    bintrayName = <span class="string">'mylib'</span></span><br><span class="line"></span><br><span class="line">  	<span class="comment">// owner的groupID</span></span><br><span class="line">    publishedGroupId = <span class="string">'com.hgDendi.test'</span></span><br><span class="line">    libraryName = <span class="string">'MyLib'</span></span><br><span class="line">    artifact = <span class="string">'mylib'</span></span><br><span class="line"></span><br><span class="line">    libraryDescription = <span class="string">'lib test demo'</span></span><br><span class="line"></span><br><span class="line">    siteUrl = <span class="string">'https://github.com/hgDendi/AndroidJCenterDemo'</span></span><br><span class="line">    gitUrl = <span class="string">'https://github.com/hgDendi/AndroidJCenterDemo.git'</span></span><br><span class="line"></span><br><span class="line">    libraryVersion = <span class="string">'0.0.1'</span></span><br><span class="line"></span><br><span class="line">    developerId = <span class="string">'dendi'</span></span><br><span class="line">    developerName = <span class="string">'Dendi Chan'</span></span><br><span class="line">    developerEmail = <span class="string">'hg.dendi@gmail.com'</span></span><br><span class="line"></span><br><span class="line">    licenseName = <span class="string">'The MIT License'</span></span><br><span class="line">    licenseUrl = <span class="string">'https://rem.mit-license.org'</span></span><br><span class="line">    allLicenses = [<span class="string">"MIT"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上所示，则最后生成的gradle script会是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile &apos;com.hgdendi.test:mylib:0.0.1&apos;</span><br></pre></td></tr></table></figure>
<h4 id="增加脚本依赖"><a href="#增加脚本依赖" class="headerlink" title="增加脚本依赖"></a>增加脚本依赖</h4><p>在lib module的build.gradle文件下增加一行apply from</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">from:</span> <span class="string">'https://raw.githubusercontent.com/hgDendi/AndroidJCenterDemo/master/bintray.gradle'</span></span><br><span class="line">apply <span class="string">from:</span> <span class="string">'https://raw.githubusercontent.com/hgDendi/AndroidJCenterDemo/master/maveninstall.gradle'</span></span><br></pre></td></tr></table></figure>
<h2 id="上传代码"><a href="#上传代码" class="headerlink" title="上传代码"></a>上传代码</h2><h3 id="执行gradlew命令将lib上传"><a href="#执行gradlew命令将lib上传" class="headerlink" title="执行gradlew命令将lib上传"></a>执行gradlew命令将lib上传</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./gradlew install</span><br><span class="line">./gradlew bintrayUpload</span><br></pre></td></tr></table></figure>
<p>这时候登录bintray，就可以看到上传结果了。</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1flfk8pysvxj31hy1a8dmc.jpg" alt="uploadSuccess"></p>
<h3 id="同步到jcenter"><a href="#同步到jcenter" class="headerlink" title="同步到jcenter"></a>同步到jcenter</h3><p>此时代码还是只在你的maven仓库，并未同步到JCenter中。</p>
<p>这时候点进你的package，点击AddToJCenter就可以将代码上传到JCenter。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1flfk8o2357j31i21dmgtg.jpg" alt="add2Jcenter"></p>
<h2 id="上传成功"><a href="#上传成功" class="headerlink" title="上传成功"></a>上传成功</h2><p>同步到JCenter有时候可能需要半天到一天的时间。</p>
<p>同步成功后，便可以使用compile从服务器拉取lib了。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line"><span class="comment">//    implementation project(':mylib')</span></span><br><span class="line">    compile <span class="string">'com.hgDendi:mylib:1.0.0'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hgworts.tech/2017/11/12/RecyclerView实现二级菜单/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hgDendi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HgWorts">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/12/RecyclerView实现二级菜单/" itemprop="url">RecyclerView实现二级菜单</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-12T00:00:00+08:00">
                2017-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ExpandableRecyclerView"><a href="#ExpandableRecyclerView" class="headerlink" title="ExpandableRecyclerView"></a>ExpandableRecyclerView</h1><p><img src="https://github.com/hgDendi/ExpandableRecyclerView/blob/master/img/expandableRecyclerView.gif" alt="demo"></p>
<p>github:<a href="https://github.com/hgDendi/ExpandableRecyclerView" target="_blank" rel="noopener">https://github.com/hgDendi/ExpandableRecyclerView</a></p>
<p>自定义支持二级菜单的RecyclerViewAdapter。</p>
<p>将展开闭合操作封装在了<a href="https://github.com/hgDendi/ExpandableRecyclerView/blob/master/expandable-recyclerview-adapter/src/main/java/com/hgdendi/expandablerecycleradapter/BaseExpandableRecyclerViewAdapter.java" target="_blank" rel="noopener">BaseExpandableRecyclerViewAdapter</a>中，使整个使用方式充满弹性。</p>
<p>下方有具体使用方法，一般需要override 6个方法：</p>
<ul>
<li><strong>getGroupCount</strong></li>
<li><strong>getGroupItem</strong></li>
<li>onCreateGroupViewHolder</li>
<li>onCreateChildViewHolder</li>
<li>onBindGroupViewHolder</li>
<li>onBindChildViewHolder</li>
</ul>
<p>因为onCreateViewHolder和onBindViewHolder本来即是RecyclerViewAdapter需要强制Override的方法，这里按父子关系拆分成了两个方法。而getGroupCount和getGroupItem在大概率情况下都是基于List的简单一行代码即可实现，故而使用起来十分简便。</p>
<h2 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies&#123;</span><br><span class="line">	compile <span class="string">'com.hgDendi:expandable-recyclerview-adapter:0.0.2'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ol>
<li>使用便捷、简洁明了</li>
<li>最大程度保留RecyclerView的原生机制，滑动到具体条目才进行渲染，不会滑到另一个Group渲染另一个Group下所有子Item</li>
<li>itemView的部分刷新，可以自定义展开、闭合时的刷新机制，避免GroupItem在展开闭合时刷新整个GroupItem（比如只是简单的箭头指向改变）</li>
<li>采用泛型，用户自定义传入参数，扩展性更高</li>
</ol>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="定义父子数据结构"><a href="#定义父子数据结构" class="headerlink" title="定义父子数据结构"></a>定义父子数据结构</h3><p>其中GroupBean需要继承自BaseGroupBean并override三个方法。</p>
<ul>
<li>getChildCount<ul>
<li>获取子节点个数</li>
</ul>
</li>
<li>isExpandable<ul>
<li>是否为可展开的节点</li>
<li>默认实现可以是判断子节点是否为0，但是也可以做其他处理</li>
</ul>
</li>
<li>getChildAt<ul>
<li>根据index获取对应的子节点数据结构</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SampleGroupBean</span> <span class="keyword">implements</span> <span class="title">BaseExpandableRecyclerViewAdapter</span>.<span class="title">BaseGroupBean</span>&lt;<span class="title">SampleChildBean</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getChildCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mList.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// whether this group is expandable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExpandable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getChildCount() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SampleChildBean <span class="title">getChildAt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mList.size() &lt;= index ? <span class="keyword">null</span> : mList.get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleChildBean</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义对应的ViewHolder"><a href="#定义对应的ViewHolder" class="headerlink" title="定义对应的ViewHolder"></a>定义对应的ViewHolder</h3><p>其中Group对应的ViewHolder要继承BaseGroupViewHolder并改写onExpandStatusChanged.</p>
<p>该方法是实现item局部刷新的方法，在展开、闭合时会回调，比如对于大多数情况，开关闭合状态只需要修改左边箭头指向，就无需刷新itemView的其他部分。</p>
<p>实现原理是使用RecyclerView的payload机制实现局部监听刷新。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupVH</span> <span class="keyword">extends</span> <span class="title">BaseExpandableRecyclerViewAdapter</span>.<span class="title">BaseGroupViewHolder</span> </span>&#123;</span><br><span class="line">    GroupVH(View itemView) &#123;</span><br><span class="line">        <span class="keyword">super</span>(itemView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this method is used for partial update.Which means when expand status changed,only a part of this view need to invalidate</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onExpandStatusChanged</span><span class="params">(RecyclerView.Adapter relatedAdapter, <span class="keyword">boolean</span> isExpanding)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 1.只更新左侧展开、闭合箭头</span></span><br><span class="line">      foldIv.setImageResource(isExpanding ? R.drawable.ic_arrow_expanding : R.drawable.ic_arrow_folding);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 2.默认刷新整个Item</span></span><br><span class="line">      relatedAdapter.notifyItemChanged(getAdapterPosition());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildVH</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">    ChildVH(View itemView) &#123;</span><br><span class="line">        <span class="keyword">super</span>(itemView);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用自定义Adapter继承基类"><a href="#使用自定义Adapter继承基类" class="headerlink" title="使用自定义Adapter继承基类"></a>使用自定义Adapter继承基类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// !!注意这里继承时候使用的泛型，分别为上面提到的Bean和ViewHolder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleAdapter</span> <span class="keyword">extends</span> <span class="title">BaseExpandableRecyclerViewAdapter</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">SampleGroupBean</span>, <span class="title">SampleChildBean</span>, <span class="title">SampleAdapter</span>.<span class="title">GroupVH</span>, <span class="title">SampleAdapter</span>.<span class="title">ChildVH</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    @<span class="title">Override</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">int</span> <span class="title">getGroupCount</span>() </span>&#123;</span><br><span class="line">        <span class="comment">// 父节点个数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GroupBean <span class="title">getGroupItem</span><span class="params">(<span class="keyword">int</span> groupIndex)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取父节点</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GroupVH <span class="title">onCreateGroupViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> groupViewType)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ChildVH <span class="title">onCreateChildViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> childViewType)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindGroupViewHolder</span><span class="params">(GroupVH holder, SampleGroupBean sampleGroupBean, <span class="keyword">boolean</span> isExpand)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindChildViewHolder</span><span class="params">(ChildVH holder, SampleGroupBean sampleGroupBean, SampleChildBean sampleChildBean)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他用法"><a href="#其他用法" class="headerlink" title="其他用法"></a>其他用法</h3><h4 id="增加父子的种类"><a href="#增加父子的种类" class="headerlink" title="增加父子的种类"></a>增加父子的种类</h4><p>通过改写getChildType和getGroupType方法进行控制type，该type会在onCreateGroupViewHolder和onCreateChildViewHolder时回传。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getGroupType</span><span class="params">(GroupBean groupBean)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> GroupViewHolder <span class="title">onCreateGroupViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> groupViewType)</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getChildType</span><span class="params">(GroupBean groupBean, ChildBean childBean)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> ChildViewHolder <span class="title">onCreateChildViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> childViewType)</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="增加列表为空时候的EmptyView"><a href="#增加列表为空时候的EmptyView" class="headerlink" title="增加列表为空时候的EmptyView"></a>增加列表为空时候的EmptyView</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">adapter.setEmptyViewProducer(<span class="keyword">new</span> ViewProducer() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RecyclerView.<span class="function">ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        View emptyView = LayoutInflater.from(parent.getContext()).inflate(R.layout.empty, parent, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultEmptyViewHolder(emptyView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(RecyclerView.ViewHolder holder)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="增加HeaderView"><a href="#增加HeaderView" class="headerlink" title="增加HeaderView"></a>增加HeaderView</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">adapter.setEmptyViewProducer(<span class="keyword">new</span> ViewProducer() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RecyclerView.<span class="function">ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        View emptyView = LayoutInflater.from(parent.getContext()).inflate(R.layout.header, parent, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultEmptyViewHolder(emptyView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(RecyclerView.ViewHolder holder)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<h4 id="监听事件"><a href="#监听事件" class="headerlink" title="监听事件"></a>监听事件</h4><p>可以通过setListener的方式设置监听事件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExpandableRecyclerViewOnClickListener</span>&lt;<span class="title">GroupBean</span> <span class="keyword">extends</span> <span class="title">BaseGroupBean</span>, <span class="title">ChildBean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 长按时的操作</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> groupItem</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onGroupLongClicked</span><span class="params">(GroupBean groupItem)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 在可展开group被点击的时候触发的回调，返回布尔值表示是否拦截该操作</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> groupItem</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> isExpand</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> true 使点击无效。false 正常执行展开、闭合操作。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onInterceptGroupExpandEvent</span><span class="params">(GroupBean groupItem, <span class="keyword">boolean</span> isExpand)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 点击GroupView时的操作(该Group的isExpandable返回false才会触发这个回调)</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> groupItem</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onGroupClicked</span><span class="params">(GroupBean groupItem)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 点击子View时的操作</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> groupItem</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> childItem</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onChildClicked</span><span class="params">(GroupBean groupItem, ChildBean childItem)</span></span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><h3 id="父子结构划分"><a href="#父子结构划分" class="headerlink" title="父子结构划分"></a>父子结构划分</h3><ol>
<li>通过getItemType判断所处类型，在基类中就先划分为四种类型的View。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_EMPTY = ViewProducer.VIEW_TYPE_EMPTY;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_HEADER = ViewProducer.VIEW_TYPE_HEADER;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_GROUP = ViewProducer.VIEW_TYPE_EMPTY &gt;&gt; <span class="number">2</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_CHILD = ViewProducer.VIEW_TYPE_EMPTY &gt;&gt; <span class="number">3</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_MASK = TYPE_GROUP | TYPE_CHILD | TYPE_EMPTY | TYPE_HEADER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过getItemView判断类型，这里默认是使用上面定义的MASK，可以重载使Group和Child中再划分子类，但是不允许和TYPE_MASK冲突，否则会报Exception</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mIsEmpty) &#123;</span><br><span class="line">        <span class="keyword">return</span> position == <span class="number">0</span> &amp;&amp; mShowHeaderViewWhenEmpty ? TYPE_HEADER : TYPE_EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (position == <span class="number">0</span> &amp;&amp; mHeaderViewProducer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> TYPE_HEADER;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span>[] coord = translateToDoubleIndex(position);</span><br><span class="line">    GroupBean groupBean = getGroupItem(coord[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (coord[<span class="number">1</span>] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> groupType = getGroupType(groupBean);</span><br><span class="line">        <span class="keyword">if</span> ((groupType &amp; TYPE_MASK) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> groupType | TYPE_GROUP;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                String.format(Locale.getDefault(), <span class="string">"GroupType [%d] conflits with MASK [%d]"</span>, groupType, TYPE_MASK));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> childType = getChildType(groupBean, groupBean.getChildAt(coord[<span class="number">1</span>]));</span><br><span class="line">        <span class="keyword">if</span> ((childType &amp; TYPE_MASK) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> childType | TYPE_CHILD;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                String.format(Locale.getDefault(), <span class="string">"ChildType [%d] conflits with MASK [%d]"</span>, childType, TYPE_MASK));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>在onCreateViewHolder和onBindViewHolder中进行类型判断，调用不同的方法，这些方法在子类中进行重载。注意这里将这三个方法都置为final，防止子类重载，子类只能重载对应不同type的具体方法。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> RecyclerView.<span class="function">ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (viewType) &#123;</span><br><span class="line">        <span class="keyword">case</span> TYPE_EMPTY:</span><br><span class="line">            <span class="keyword">return</span> mEmptyViewProducer.onCreateViewHolder(parent);</span><br><span class="line">        <span class="keyword">case</span> TYPE_HEADER:</span><br><span class="line">            <span class="keyword">return</span> mHeaderViewProducer.onCreateViewHolder(parent);</span><br><span class="line">        <span class="keyword">case</span> TYPE_CHILD:</span><br><span class="line">            <span class="keyword">return</span> onCreateChildViewHolder(parent, viewType ^ TYPE_CHILD);</span><br><span class="line">        <span class="keyword">case</span> TYPE_GROUP:</span><br><span class="line">            <span class="keyword">return</span> onCreateGroupViewHolder(parent, viewType ^ TYPE_GROUP);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                String.format(Locale.getDefault(), <span class="string">"Illegal view type : viewType[%d]"</span>, viewType));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(<span class="keyword">final</span> RecyclerView.ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    onBindViewHolder(holder, position, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(RecyclerView.ViewHolder holder, <span class="keyword">int</span> position, List&lt;Object&gt; payloads)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (holder.getItemViewType() &amp; TYPE_MASK) &#123;</span><br><span class="line">        <span class="keyword">case</span> TYPE_EMPTY:</span><br><span class="line">            mEmptyViewProducer.onBindViewHolder(holder);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TYPE_HEADER:</span><br><span class="line">            mHeaderViewProducer.onBindViewHolder(holder);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TYPE_CHILD:</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span>[] childCoord = translateToDoubleIndex(position);</span><br><span class="line">            GroupBean groupBean = getGroupItem(childCoord[<span class="number">0</span>]);</span><br><span class="line">            bindChildViewHolder((ChildViewHolder) holder, groupBean, groupBean.getChildAt(childCoord[<span class="number">1</span>]), payloads);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TYPE_GROUP:</span><br><span class="line">            bindGroupViewHolder((GroupViewHolder) holder,</span><br><span class="line">                getGroupItem(translateToDoubleIndex(position)[<span class="number">0</span>]), payloads);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                String.format(Locale.getDefault(), <span class="string">"Illegal view type : position [%d] ,itemViewType[%d]"</span>, position, holder.getItemViewType()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="展开闭合操作"><a href="#展开闭合操作" class="headerlink" title="展开闭合操作"></a>展开闭合操作</h3><h4 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h4><p>当groupBean的isExpandable返回true的时候，为itemView设置点击事件，进行展开闭合。</p>
<p>展开闭合的具体原理是在Set中记录展开闭合情况，当发生展开、闭合操作的时候进行更新，并使用notifyItemChange接口进行列表的局部刷新。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Set&lt;GroupBean&gt; mExpandGroupSet;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">bindGroupViewHolder</span><span class="params">(<span class="keyword">final</span> GroupViewHolder holder, <span class="keyword">final</span> GroupBean groupBean, List&lt;Object&gt; payload)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (!groupBean.isExpandable()) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        holder.itemView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> isExpand = mExpandGroupSet.contains(groupBean);</span><br><span class="line">                <span class="keyword">if</span> (mListener == <span class="keyword">null</span> || !mListener.onInterceptGroupExpandEvent(groupBean, isExpand)) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> adapterPosition = holder.getAdapterPosition();</span><br><span class="line">                holder.onExpandStatusChanged(BaseExpandableRecyclerViewAdapter.<span class="keyword">this</span>, !isExpand);</span><br><span class="line">                    <span class="keyword">if</span> (isExpand) &#123;</span><br><span class="line">                        mExpandGroupSet.remove(groupBean);</span><br><span class="line">                        notifyItemRangeRemoved(adapterPosition + <span class="number">1</span>, groupBean.getChildCount());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mExpandGroupSet.add(groupBean);</span><br><span class="line">                        notifyItemRangeInserted(adapterPosition + <span class="number">1</span>, groupBean.getChildCount());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// 子类实现</span></span><br><span class="line">    onBindGroupViewHolder(holder, groupBean, isGroupExpand(groupBean));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="局部刷新原理"><a href="#局部刷新原理" class="headerlink" title="局部刷新原理"></a>局部刷新原理</h4><p>定义了Payload，采用Payload机制进行局部刷新。</p>
<p>在notifyItemChange时传入payload，在onBindViewHolder操作中判断是否带有payload，若带有payload，则执行部分刷新的操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object EXPAND_PAYLOAD = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 局部刷新时调用的接口(已封装好，用户无需调用)</span></span><br><span class="line">notifyItemChanged(position, EXPAND_PAYLOAD);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理payload</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">bindGroupViewHolder</span><span class="params">(<span class="keyword">final</span> GroupViewHolder holder, <span class="keyword">final</span> GroupBean groupBean, List&lt;Object&gt; payload)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (payload != <span class="keyword">null</span> &amp;&amp; payload.size() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (payload.contains(EXPAND_PAYLOAD)) &#123;</span><br><span class="line">          	<span class="comment">// holder方法有抽象方法，在此方法中实现具体的展开、闭合逻辑</span></span><br><span class="line">            holder.onExpandStatusChanged(BaseExpandableRecyclerViewAdapter.<span class="keyword">this</span>, isGroupExpand(groupBean));</span><br><span class="line">            <span class="keyword">if</span> (payload.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    onBindGroupViewHolder(holder, groupBean, isGroupExpand(groupBean), payload);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hgworts.tech/2017/11/11/网络/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hgDendi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HgWorts">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/11/网络/" itemprop="url">网络相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-11T00:00:00+08:00">
                2017-11-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">network</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><h2 id="URI"><a href="#URI" class="headerlink" title="URI"></a>URI</h2><p>Uniform Resource identifier</p>
<p>统一资源标识符，用来唯一的标志一个<strong>资源</strong></p>
<p>File://a:1234/b/c/d.txt</p>
<ul>
<li>访问资源的命名机制</li>
<li>主机名</li>
<li>资源自身的名称，由路径展示</li>
</ul>
<h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><p>Universal Resource Locator</p>
<p>统一资源定位器，是一种<strong>具体的URI</strong></p>
<p>可以用来标志一个资源，还指明了如何locate这个资源</p>
<ul>
<li>协议</li>
<li>存有该资源的主机IP地址</li>
<li>主机资源具体地址</li>
</ul>
<h2 id="分层"><a href="#分层" class="headerlink" title="分层"></a>分层</h2><ul>
<li>应用层<ul>
<li>收到传输层数据后按格式进行解读</li>
<li>HTTP、FTP、Telnet、SMTP、POP3</li>
</ul>
</li>
<li>传输层<ul>
<li>建立主机到主机的通信，为两台主机上的应用提供端到端的通信</li>
<li>TCP UDP</li>
</ul>
</li>
<li>网络层<ul>
<li>决定如何将数据从发送方路由到接收方</li>
<li>综合考虑发送优先权、网络拥塞程度、服务质量、可选路由的花费</li>
<li>ip协议</li>
</ul>
</li>
<li>数据链路层<ul>
<li>从网络层接收到的数据被分割成特定的可被物理层传输的帧</li>
<li>原始数据、发送方和接收方的物理地址、纠错和控制信息</li>
</ul>
</li>
<li>物理层</li>
</ul>
<h1 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h1><p>是面向对象协议，使用于分布式超媒体信息系统。</p>
<ul>
<li>支持CS模式</li>
<li>简单快速</li>
<li>灵活，允许传输任意类型的数据</li>
<li><strong>无连接</strong>，限制每次连接只处理一个请求</li>
<li><strong>无状态</strong>，对于事务处理没有记忆能力</li>
</ul>
<h2 id="URL格式"><a href="#URL格式" class="headerlink" title="URL格式"></a>URL格式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://host[&quot;:&quot;port][abs_path]</span><br></pre></td></tr></table></figure>
<h2 id="Cookie和Session"><a href="#Cookie和Session" class="headerlink" title="Cookie和Session"></a>Cookie和Session</h2><h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><p>是<strong>客户端</strong>的解决方案（HTTP是无状态的），是服务器发给客户端的特殊信息，这些信息以文本文件的方式存放在客户端，然后客户端每次向服务器发送请求的时候都会带上这些特殊的信息。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fle3tlox07j30kw0acwez.jpg" alt="1510379800835"></p>
<h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><p>保存在<strong>服务器</strong>上。客户端浏览器访问Server的时候，Server把客户端信息以某种形式记录在服务器上。</p>
<h2 id="请求报文"><a href="#请求报文" class="headerlink" title="请求报文"></a>请求报文</h2><p><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1507393085215&amp;di=31c995f6e06cee71486a2e79fecf4f23&amp;imgtype=0&amp;src=http%3A%2F%2Froclinux.cn%2Fwp-content%2Fuploads%2F2013%2F12%2FHTTP%25E5%258D%258F%25E8%25AE%25AE-%25E8%25AF%25B7%25E6%25B1%2582%25E6%258A%25A5%25E6%2596%2587%25E6%25A0%25BC%25E5%25BC%258F.png" alt="requestHttp"></p>
<ul>
<li>请求行</li>
<li>请求报头</li>
<li>请求数据</li>
</ul>
<h3 id="请求行"><a href="#请求行" class="headerlink" title="请求行"></a>请求行</h3><p>Method Request-URI HTTP-VERSION CRLF</p>
<blockquote>
<p>GET <a href="http://blog.csdn.net/" target="_blank" rel="noopener">http://blog.csdn.net/</a> HTTP/1.1</p>
</blockquote>
<p>八种请求方法：</p>
<ul>
<li>GET<ul>
<li>请求获取Request-URI所标识的资源</li>
<li>大小有限制</li>
</ul>
</li>
<li>POST<ul>
<li>在Request-URI所标识的资源后附加新的数据</li>
<li>数据放在body中，无大小限制</li>
</ul>
</li>
<li>HEAD<ul>
<li>请求获取由URI所标志的资源的响应消息报头</li>
</ul>
</li>
<li>PUT<ul>
<li>请求服务器存储一个资源，并用URI作为其标识</li>
</ul>
</li>
<li>DELETE<ul>
<li>请求服务器删除URI所标识的资源</li>
</ul>
</li>
<li>TRACE<ul>
<li>请求服务器回送收到的请求信息，主要用于测试或诊断</li>
</ul>
</li>
<li>CONNECT<ul>
<li>预留给能够将连接改为管道方式的代理服务器</li>
</ul>
</li>
<li>OPTIONS<ul>
<li>能够查询服务器的性能</li>
</ul>
</li>
</ul>
<h2 id="响应报文"><a href="#响应报文" class="headerlink" title="响应报文"></a>响应报文</h2><p><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1507393435182&amp;di=a151b5ba1fa56eb7a8964ee0297fcc5e&amp;imgtype=0&amp;src=http%3A%2F%2Froclinux.cn%2Fwp-content%2Fuploads%2F2013%2F12%2FHTTP%25E5%258D%258F%25E8%25AE%25AE-%25E5%2593%258D%25E5%25BA%2594%25E6%258A%25A5%25E6%2596%2587%25E6%25A0%25BC%25E5%25BC%258F1.png" alt="responseHTTP"></p>
<ul>
<li>状态行</li>
<li>响应报头</li>
<li>空行</li>
</ul>
<h3 id="状态行"><a href="#状态行" class="headerlink" title="状态行"></a>状态行</h3><p>HTTP-Version Status-Code Reason-phrase CRLF</p>
<blockquote>
<p>HTTP/1.1 200 OK</p>
</blockquote>
<ul>
<li>100~199<ul>
<li>收到请求，需要请求者继续执行操作</li>
</ul>
</li>
<li>200~299<ul>
<li>请求成功，请求已被成功接收并处理</li>
<li>200 OK</li>
</ul>
</li>
<li>300~399<ul>
<li>重定向，要完成请求必须进行更进一步的操作</li>
</ul>
</li>
<li>400~499<ul>
<li>客户端错误，请求有语法错误或请求无法实现</li>
<li>400 Bad Request</li>
<li>401 Unauthorized</li>
<li>403 Forbidden</li>
</ul>
</li>
<li>500~599<ul>
<li>服务器错误，服务器不能实现合法的请求</li>
<li>500 Internal Server Error</li>
<li>503 Server Unavailable</li>
</ul>
</li>
</ul>
<h2 id="消息报头"><a href="#消息报头" class="headerlink" title="消息报头"></a>消息报头</h2><h3 id="通用部分"><a href="#通用部分" class="headerlink" title="通用部分"></a>通用部分</h3><ul>
<li>Date</li>
<li>Connection</li>
<li>Cache-Control</li>
</ul>
<h3 id="请求报头"><a href="#请求报头" class="headerlink" title="请求报头"></a>请求报头</h3><ul>
<li>Host<ul>
<li>请求主机名</li>
</ul>
</li>
<li>User-Agent<ul>
<li>发送请求的浏览器类型</li>
</ul>
</li>
<li>Accept<ul>
<li>指定客户端接收哪些类型的信息</li>
<li>比如<em>/</em></li>
</ul>
</li>
<li>Refer<ul>
<li>从哪个链接链接过来的</li>
</ul>
</li>
<li>Accept-Encoding<ul>
<li>客户端可识别的数据编码</li>
</ul>
</li>
<li>Accept-Language<ul>
<li>浏览器支持的语言类型</li>
</ul>
</li>
<li>Connection<ul>
<li>允许客户端和服务器指定与请求、响应连接有关的选项</li>
<li>如Keep-Alive</li>
</ul>
</li>
<li>if-none-match<ul>
<li>缓存</li>
<li>返回304，直接使用本地缓存</li>
</ul>
</li>
<li>If-modified-since<ul>
<li>返回304，直接使用本地缓存</li>
</ul>
</li>
</ul>
<ul>
<li>Transfer-Encoding<ul>
<li>告知接收端为了保证报文的可靠传输，对报文采用了什么编码方式</li>
</ul>
</li>
</ul>
<h3 id="响应报头"><a href="#响应报头" class="headerlink" title="响应报头"></a>响应报头</h3><ul>
<li>Location<ul>
<li>用于重定向接收者到一个新的位置</li>
</ul>
</li>
<li>Server<ul>
<li>包含服务器用来处理请求的系统信息</li>
</ul>
</li>
<li>ETag<ul>
<li>标志服务端信息的标志位</li>
<li>和if-none-match配对</li>
</ul>
</li>
<li>Expires<ul>
<li>缓存时间控制</li>
</ul>
</li>
<li>Cache-Control</li>
<li>Proxy-Connection<ul>
<li>keep-alive</li>
</ul>
</li>
</ul>
<h3 id="实体报头"><a href="#实体报头" class="headerlink" title="实体报头"></a>实体报头</h3><ul>
<li>Content-Type<ul>
<li>发送给接收者的实体正文的媒体类型</li>
</ul>
</li>
<li>Content-Length<ul>
<li>实体正文的长度</li>
</ul>
</li>
<li>Content-Language</li>
<li>Content-Encoding</li>
<li>Last-Modified<ul>
<li>指示资源的最后修改时间和日期</li>
</ul>
</li>
<li>Expires<ul>
<li>响应过期的日期和时间</li>
</ul>
</li>
</ul>
<h2 id="HTTP-1-X-协议存在的问题"><a href="#HTTP-1-X-协议存在的问题" class="headerlink" title="HTTP 1.X 协议存在的问题"></a>HTTP 1.X 协议存在的问题</h2><ul>
<li>传输数据时，每次都要重新建立链接</li>
<li>所有传输内容都是明文，客户端和服务器无法验证对方身份</li>
<li>header里携带的内容过大，在一定程度上增加了传输成本</li>
<li>虽然支持keep-alive，来弥补多次创建连接产生的延迟，但是使用多了同样会给服务器带来大量的性能压力</li>
</ul>
<h1 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h1><h2 id="HTTPS-1"><a href="#HTTPS-1" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>不是一个单独的协议，是对工作在加密连接（SSL/TLS）上的常规HTTP协议。</p>
<p>通过在TCP和HTTP之间加入TLS来加密。</p>
<h2 id="SSL-TLS"><a href="#SSL-TLS" class="headerlink" title="SSL/TLS"></a>SSL/TLS</h2><p>SSL协议是一种安全传输协议。</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fle45c3xxcj30yy0ja0uv.jpg" alt="1510380517163"></p>
<h3 id="TCP和UDP"><a href="#TCP和UDP" class="headerlink" title="TCP和UDP"></a>TCP和UDP</h3><table>
<thead>
<tr>
<th>TCP</th>
<th>UDP</th>
</tr>
</thead>
<tbody>
<tr>
<td>基于连接，全双工的可靠信道</td>
<td>无连接，不可靠信道</td>
</tr>
<tr>
<td>要求系统资源较多</td>
<td>较少</td>
</tr>
<tr>
<td>流模式</td>
<td>数据报模式</td>
</tr>
<tr>
<td>保证数据正确性</td>
<td>可能丢包</td>
</tr>
<tr>
<td>保证数据顺序</td>
<td>不保证</td>
</tr>
<tr>
<td>文件传输、重要状态的更新</td>
<td>视频传输、实时通信</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h1 id="Android中的网络通信框架"><a href="#Android中的网络通信框架" class="headerlink" title="Android中的网络通信框架"></a>Android中的网络通信框架</h1><h2 id="HttpURLConnection"><a href="#HttpURLConnection" class="headerlink" title="HttpURLConnection"></a>HttpURLConnection</h2><p>API简单，体积较小，适应于Android项目，而且其压缩和缓存机制可以有效的减少网络访问的流量。</p>
<h3 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">URL mURL = <span class="keyword">new</span> URL(url);</span><br><span class="line">httpURLConnection = (HttpURLConnection) mURL.openConnection();</span><br><span class="line">httpURLConnection.setConnectTimeout(<span class="number">15000</span>);</span><br><span class="line">httpURLConnection.setReadTimeout(<span class="number">15000</span>);</span><br><span class="line">httpURLConnection.setRequestMethod(<span class="string">"GET"</span>);</span><br><span class="line">httpURLConnection.setRequestProperty(<span class="string">"Connection"</span>, <span class="string">"Keep-Alive"</span>);</span><br><span class="line">httpURLConnection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">httpURLConnection.connect();</span><br><span class="line"></span><br><span class="line">inputStream = httpURLConnection.getInputStream();</span><br><span class="line"><span class="keyword">int</span> code = httpURLConnection.getResponseCode();</span><br><span class="line">String response = UrlConnManager.convertStreamToString(inputStream);</span><br><span class="line">inputStream.close();</span><br></pre></td></tr></table></figure>
<h3 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">URL mURL = <span class="keyword">new</span> URL(url);</span><br><span class="line">httpURLConnection = (HttpURLConnection) mURL.openConnection();</span><br><span class="line"></span><br><span class="line">httpURLConnection.setConnectTimeout(<span class="number">15000</span>);</span><br><span class="line">httpURLConnection.setReadTimeout(<span class="number">15000</span>);</span><br><span class="line">httpURLConnection.setRequestMethod(<span class="string">"POST"</span>);</span><br><span class="line">httpURLConnection.setRequestProperty(<span class="string">"Connection"</span>, <span class="string">"Keep-Alive"</span>);</span><br><span class="line">httpURLConnection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">//post传递参数时需要开启</span></span><br><span class="line">httpURLConnection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//post body</span></span><br><span class="line">OutputStream outputStream = httpURLConnection.getOutputStream();</span><br><span class="line">StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"><span class="keyword">for</span> (NameValuePair nameValuePair : paramsList) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(sb)) &#123;</span><br><span class="line">        sb.append(<span class="string">"&amp;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sb.append(URLEncoder.encode(nameValuePair.getName(), <span class="string">"UTF-8"</span>));</span><br><span class="line">    sb.append(<span class="string">"="</span>);</span><br><span class="line">    sb.append(URLEncoder.encode(nameValuePair.getValue(), <span class="string">"UTF-8"</span>));</span><br><span class="line">&#125;</span><br><span class="line">BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(outputStream, <span class="string">"UTF-8"</span>));</span><br><span class="line">writer.write(sb.toString());</span><br><span class="line">writer.flush();</span><br><span class="line">writer.close();</span><br><span class="line"></span><br><span class="line">httpURLConnection.connect();</span><br><span class="line">inputStream = httpURLConnection.getInputStream();</span><br><span class="line"><span class="keyword">int</span> code = httpURLConnection.getResponseCode();</span><br><span class="line">String response = UrlConnManager.convertStreamToString(inputStream);</span><br><span class="line">inputStream.close();</span><br></pre></td></tr></table></figure>
<h2 id="Volley"><a href="#Volley" class="headerlink" title="Volley"></a>Volley</h2><p>适合进行数据量不大但通信频繁的网络操作</p>
<p>对于大数据量的网络操作，比如下载文件等，表现就比较糟糕。</p>
<p>基于HttpURLConnection。</p>
<p>基于队列，有四个NetworkDispatcher，一个CacheDispatcher。</p>
<ol>
<li>创建RequestQueue</li>
</ol>
<ol>
<li>创建XXRequest</li>
<li>RequestQueue#add</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">RequestQueue queue = Volley.newRequestQueue(getApplicationContext());</span><br><span class="line">StringRequest stringRequest = <span class="keyword">new</span> StringRequest(</span><br><span class="line">    Request.Method.GET,</span><br><span class="line">    <span class="string">"https://www.baidu.com"</span>,</span><br><span class="line">    <span class="keyword">new</span> Response.Listener&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response)</span> </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"===="</span> + response);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">new</span> Response.ErrorListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line">JsonObjectRequest jsonObjectRequest = <span class="keyword">new</span> JsonObjectRequest(</span><br><span class="line">    <span class="string">"http://ip.taobao.com/service/getIpInfo.php?ip=59.108.54.37"</span>,</span><br><span class="line">    <span class="keyword">null</span>,</span><br><span class="line">    <span class="keyword">new</span> Response.Listener&lt;JSONObject&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(JSONObject response)</span> </span>&#123;</span><br><span class="line">             IpModel ipModel = <span class="keyword">new</span> Gson().fromJson(response.toString(), IpModel.class);</span><br><span class="line">             Log.d(TAG, <span class="string">"====ip"</span> + ipModel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">new</span> Response.ErrorListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line">queue.add(stringRequest);</span><br><span class="line">queue.add(jsonObjectRequest);</span><br></pre></td></tr></table></figure>
<h2 id="OKHttp"><a href="#OKHttp" class="headerlink" title="OKHttp"></a>OKHttp</h2><p>会从很多常用的连接问题中自动恢复，比如服务器配置了多个IP，当第一个IP连接失败时，会自动尝试下一个IP。（原理是通过拦截器进行实现）</p>
<p>Fresco、Glide、Picasso、Retrofit都使用了OkHttp</p>
<p>使用方法：</p>
<ol>
<li>通过RequestBuilder创建Request</li>
<li>创建OkHttpClient</li>
<li>通过OkHttpClient#newCall(Request)创建Call</li>
<li>调用Call#enqueue或execute</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">okhttp3.Request.Builder requestBuilder = <span class="keyword">new</span> okhttp3.Request.Builder().url(<span class="string">"http://blog.csdn.net/itachi85"</span>);</span><br><span class="line"><span class="comment">//POST请求需要用FormBody封装请求的参数</span></span><br><span class="line">requestBuilder.method(<span class="string">"GET"</span>, <span class="keyword">null</span>);</span><br><span class="line">okhttp3.Request request = requestBuilder.build();</span><br><span class="line"></span><br><span class="line">OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">Call call = okHttpClient.newCall(request);</span><br><span class="line"></span><br><span class="line">call.enqueue(<span class="keyword">new</span> Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, okhttp3.Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"===="</span> + response.body().toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Retrofit"><a href="#Retrofit" class="headerlink" title="Retrofit"></a>Retrofit</h2><p>底层是基于OkHttp实现的。</p>
<p>与其他框架不同的是，更多使用运行时注解的方式提供功能。</p>
<p>使用方法：</p>
<ol>
<li>创建Retrofit</li>
<li>使用Retrofit创建对应的接口，使用接口返回Call</li>
<li>Call#enqueue或者execute</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//POST</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IpServiceForPost</span> </span>&#123;</span><br><span class="line">    <span class="meta">@FormUrlEncoded</span></span><br><span class="line">    <span class="meta">@POST</span>(<span class="string">"&#123;path&#125;/getIpInfo.php"</span>)</span><br><span class="line">    <span class="function">Call&lt;IpModel&gt; <span class="title">getIpMsg</span><span class="params">(@Path(<span class="string">"path"</span>)</span> String path, @<span class="title">Field</span><span class="params">(<span class="string">"ip"</span>)</span> String first)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//GET</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IpService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"&#123;path&#125;/getIpInfo.php"</span>)</span><br><span class="line">    <span class="function">Call&lt;IpModel&gt; <span class="title">getIpMsg</span><span class="params">(@Path(<span class="string">"path"</span>)</span> String path, @<span class="title">Query</span><span class="params">(<span class="string">"ip"</span>)</span> String ip)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//其他注解</span></span><br><span class="line"><span class="comment">//Path：地址</span></span><br><span class="line"><span class="comment">//Query(Map)</span></span><br><span class="line"><span class="comment">//Field</span></span><br><span class="line"><span class="comment">//Body 数据传输类型JSON字符串</span></span><br><span class="line"><span class="comment">//Part 单个文件上传</span></span><br><span class="line"><span class="comment">//Header 消息报头</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">String url = <span class="string">"http://ip.taobao.com/"</span>;</span><br><span class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">    .baseUrl(url)</span><br><span class="line">    .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">    .build();</span><br><span class="line">IpService ipService = retrofit.create(IpService.class);</span><br><span class="line">retrofit2.Call&lt;IpModel&gt; call = ipService.getIpMsg(<span class="string">"service"</span>,<span class="string">"59.108.54.37"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步方法使用execute</span></span><br><span class="line">call.enqueue(<span class="keyword">new</span> retrofit2.Callback&lt;IpModel&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(retrofit2.Call&lt;IpModel&gt; call, retrofit2.Response&lt;IpModel&gt; response)</span> </span>&#123;</span><br><span class="line">        String country = response.body().toString();</span><br><span class="line">        Log.d(TAG, <span class="string">"==== coutry is "</span> + country);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(retrofit2.Call&lt;IpModel&gt; call, Throwable t)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hgworts.tech/2017/05/11/Gradle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hgDendi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HgWorts">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/11/Gradle/" itemprop="url">Gradle初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-11T00:00:00+08:00">
                2017-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/groovy/" itemprop="url" rel="index">
                    <span itemprop="name">groovy</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h2 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h2><p>基于Groovy脚本语言进行构建的。Google选用它作为默认的Android编译工具。</p>
<p><a href="http://gradle.org/documentation" target="_blank" rel="noopener">Gradle的官方文档</a></p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><h3 id="全局build-gradle"><a href="#全局build-gradle" class="headerlink" title="全局build.gradle"></a>全局build.gradle</h3><p>可以为项目整体配置一些属性。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter() <span class="comment">//指定使用jcenter代码仓库</span></span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">'com.android.tools.build:gradle:2.2.3'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// 好处是这样写之后，可以将配置进行统一管理。坏处是更新通知检查机制就无效了。</span></span><br><span class="line">    ext.global_compileSdkVersion = <span class="number">25</span></span><br><span class="line">    ext.global_buildToolsVersion = <span class="string">"25.0.0"</span></span><br><span class="line">    ext.global_minSdkVersion = <span class="number">16</span></span><br><span class="line">    ext.global_targetSdkVersion = <span class="number">25</span></span><br><span class="line">  	ext.global_ndkCommand = getNdkCommand()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//windows下使用.cmd，Linux和MacOS使用无后缀</span></span><br><span class="line"><span class="keyword">def</span> <span class="keyword">static</span> getNdkCommand() &#123;</span><br><span class="line">    <span class="keyword">if</span> (System.properties[<span class="string">'os.name'</span>].toLowerCase().contains(<span class="string">'windows'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ndk-build.cmd"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ndk-build"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(<span class="string">type:</span> Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Module-build-gradle"><a href="#Module-build-gradle" class="headerlink" title="Module build.gradle"></a>Module build.gradle</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//描述Gradle所引入的插件,如果该模块是Library，则将application改为library</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//该Module构建过程中所用到的所有参数</span></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion global_compileSdkVersion</span><br><span class="line">    buildToolsVersion global_buildToolsVersion</span><br><span class="line">    sourceSets.main &#123;</span><br><span class="line">        jni.srcDirs = [] <span class="comment">// disable auto ndk build</span></span><br><span class="line">        jniLibs.srcDir <span class="string">'src/main/libs'</span></span><br><span class="line">      	res.srcDir = [<span class="string">'src/main/res/'</span>,</span><br><span class="line">                      <span class="string">'src/main/res/layout/activity'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">"com.xxx.xxx"</span></span><br><span class="line">        minSdkVersion global_minSdkVersion</span><br><span class="line">      	<span class="comment">// 此参数表示能适应该版本的新特性，如设置为23，就需要支持动态权限</span></span><br><span class="line">        targetSdkVersion global_targetSdkVersion</span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">"1.0"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// NDK build task，global_ndkCommand是因为各平台ndk-build命令不同做的区分处理</span></span><br><span class="line">    task buildNative(<span class="string">type:</span> Exec, <span class="string">description:</span> <span class="string">'Compile JNI source via NDK'</span>) &#123;</span><br><span class="line">        <span class="keyword">def</span> ndkDir = android.ndkDirectory</span><br><span class="line">        commandLine <span class="string">"$ndkDir/$global_ndkCommand"</span>,,</span><br><span class="line">                <span class="string">'-C'</span>, file(<span class="string">'src/main/jni'</span>).absolutePath,</span><br><span class="line">                <span class="string">'-j'</span>, Runtime.runtime.availableProcessors(),</span><br><span class="line">                <span class="string">'all'</span>,</span><br><span class="line">                <span class="string">'NDK_DEBUG=1'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    task cleanNative(<span class="string">type:</span> Exec, <span class="string">description:</span> <span class="string">'Clean JNI object files'</span>) &#123;</span><br><span class="line">        <span class="keyword">def</span> ndkDir = android.ndkDirectory</span><br><span class="line">        commandLine <span class="string">"$ndkDir/ndk-build.cmd"</span>,</span><br><span class="line">                <span class="string">'-C'</span>, file(<span class="string">'src/main/jni'</span>).absolutePath,</span><br><span class="line">                <span class="string">'clean'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clean.dependsOn <span class="string">'cleanNative'</span></span><br><span class="line"></span><br><span class="line">    tasks.withType(JavaCompile) &#123;</span><br><span class="line">        compileTask -&gt; compileTask.dependsOn buildNative</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">//签名，使用签名需要到buildTypes里面进行signingConfig设置</span></span><br><span class="line">  	signingConfigs&#123;</span><br><span class="line">      	ch&#123;</span><br><span class="line">          	storeFile file(<span class="string">"aaa_key.jks"</span>)</span><br><span class="line">          	storePassword <span class="string">"1234567"</span></span><br><span class="line">          	keyAlias <span class="string">"aaa"</span></span><br><span class="line">          	keyPassword <span class="string">"1234567"</span></span><br><span class="line">      	&#125;</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            debuggable <span class="literal">true</span></span><br><span class="line">          	<span class="comment">//是否开启混淆，另外还有功能是将非使用到的东西不进行打包进apk</span></span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">          	<span class="comment">//混淆规则</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">          	shrinkResources <span class="literal">true</span><span class="comment">//此配置只有在minifyEnabled成功情况下才能开启，资源精简</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">      	ch.initWith(buildTypes.release)</span><br><span class="line">      	ch&#123;</span><br><span class="line">          	<span class="comment">//applicationID增加后缀，Android系统以此为主键，故而可以通过增加后缀的方式同时安装app</span></span><br><span class="line">        	applicationIdSuffix <span class="string">".ch"</span></span><br><span class="line">          	signingConfig signingConfigs.ch</span><br><span class="line">      	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile fileTree(<span class="string">include:</span> [<span class="string">'*.jar'</span>], <span class="string">dir:</span> <span class="string">'libs'</span>)</span><br><span class="line">    compile <span class="string">'com.android.support:appcompat-v7:25.0.0'</span></span><br><span class="line">    compile <span class="string">'com.android.support:recyclerview-v7:25.0.0'</span></span><br><span class="line">    compile <span class="string">'com.android.support:design:25.0.0'</span></span><br><span class="line">    compile project(<span class="string">':pulltorefresh'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="local-properties"><a href="#local-properties" class="headerlink" title="local.properties"></a>local.properties</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ndk.dir=G\:\\android-ndk-r10</span><br><span class="line">sdk.dir=E\:\\sdk</span><br></pre></td></tr></table></figure>
<h3 id="可选配置"><a href="#可选配置" class="headerlink" title="可选配置"></a>可选配置</h3><h4 id="在android领域中"><a href="#在android领域中" class="headerlink" title="在android领域中"></a>在android领域中</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//java编译版本</span></span><br><span class="line">compileOptions&#123;</span><br><span class="line">  	sourceCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">  	targetCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//控制lint代码检查,Lint的编译检查是Gradle编译的耗时大户</span></span><br><span class="line">lintOptions&#123;</span><br><span class="line">  	abortOnError <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Proguard</span></span><br><span class="line">minifyEnabled <span class="literal">true</span></span><br><span class="line">shrinkResources <span class="literal">true</span></span><br><span class="line">proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>),<span class="string">'proguard-rules.pro'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义Task，执行Task方式是gradle taskName</span></span><br><span class="line">task testTask &lt;&lt; &#123;</span><br><span class="line">  	println project</span><br><span class="line">    println project.name</span><br><span class="line">    println project.buildDir</span><br><span class="line">    println project.buildFile</span><br><span class="line">    println project.version</span><br><span class="line">    println name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="gradle-properties"><a href="#gradle-properties" class="headerlink" title="gradle.properties"></a>gradle.properties</h4><p>进行一些动态配置，将一些键、值写在SystemProp中</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. 配置到SystemProp中</span></span><br><span class="line">systemProp.keyAlias = ch</span><br><span class="line"><span class="comment">//在signingConfig中引用</span></span><br><span class="line">keyAlias System.properties[<span class="string">'keyAlias'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 使用KEY/VALUE进行配置</span></span><br><span class="line">ch.keyAlias = ch</span><br><span class="line"><span class="comment">//在signingConfig中引用</span></span><br><span class="line">keyAlias project.property[<span class="string">'ch.keyAlias'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 属性方式进行配置，缺点是不可以在命令行中设置参数</span></span><br><span class="line">pKeyAlias = ch</span><br><span class="line"><span class="comment">//在signingConfig中引用</span></span><br><span class="line">keyAlias pKeyAlias</span><br></pre></td></tr></table></figure>
<h4 id="flavor"><a href="#flavor" class="headerlink" title="flavor"></a>flavor</h4><p>测试代码和实际代码可以使用flavor进行配置。</p>
<p>然后从AS的build variants可以选择自己需要运行的配置参数即可运行。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">productFlavors&#123;</span><br><span class="line">  	mock&#123;&#125;</span><br><span class="line">  	</span><br><span class="line">  	prod&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//release版本不需要mock这个flavor</span></span><br><span class="line">android.variantFilter&#123; variant -&gt;</span><br><span class="line">	<span class="keyword">if</span>(variant.buildType.name.equals(<span class="string">'release'</span>))&#123;</span><br><span class="line">      	variant.getFlavors.name.equals(<span class="string">'release'</span>)&#123;</span><br><span class="line">          	variant.getFlavors().each() &#123;flavor -&gt;</span><br><span class="line">            	<span class="keyword">if</span>(flavor.name.equals(<span class="string">'mock'</span>))&#123;</span><br><span class="line">                  	variant.setIgnore(<span class="literal">true</span>);</span><br><span class="line">            	&#125;</span><br><span class="line">            &#125;</span><br><span class="line">      	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="多渠道打包"><a href="#多渠道打包" class="headerlink" title="多渠道打包"></a>多渠道打包</h4><blockquote>
<p>实际上就是在代码层面上标记不同的渠道名</p>
</blockquote>
<ol>
<li><p>创建渠道占位符(比如${CHANNEL_VALUE}就是渠道占位符)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">	<span class="attr">android:name</span>=<span class="string">"PRODUCT"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">android:value</span>=<span class="string">"$&#123;CHANNEL_VALUE&#125;"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Gradle脚本，一般在android领域中添加productFlavors</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">productFlavors&#123;</span><br><span class="line">  	product1&#123;</span><br><span class="line">      	manifestPlaceholders = [<span class="string">CHANNEL_VALUE:</span><span class="string">"PRODUCT 1"</span>]</span><br><span class="line">  	&#125;</span><br><span class="line">  	</span><br><span class="line">  	product2&#123;</span><br><span class="line">      	manifestPlaceholders = [<span class="string">CHANNEL_VALUE:</span><span class="string">"PRODUCT 2"</span>]</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以这样优化，即不在productX中定义，直接统一定义在外部</span></span><br><span class="line">productFlavors.all&#123;</span><br><span class="line">  	flavor-&gt; flavor.manifestPlaceholders = [<span class="string">CHANNEL_VALUE:</span>name]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="重命名包"><a href="#重命名包" class="headerlink" title="重命名包"></a>重命名包</h4><p>包的默认命名是 app-渠道名-buildType.apk</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">applicationVariants.all&#123;</span><br><span class="line">  	variant -&gt;</span><br><span class="line">  	variant.output.each&#123;</span><br><span class="line">      	output -&gt;</span><br><span class="line">      	<span class="keyword">if</span>(output.outputFile !=<span class="literal">null</span></span><br><span class="line">      		&amp;&amp; output.outputFile.name.endsWith(<span class="string">'.apk'</span>)</span><br><span class="line">      		&amp;&amp; <span class="string">'release'</span>.equals(variant.buildType.name))&#123;</span><br><span class="line">              	<span class="keyword">def</span> apkFile = <span class="keyword">new</span> File(output.outputFile.getParent(),</span><br><span class="line">              		<span class="string">"CHApp_$&#123;variant.flavorName&#125;_ver$&#123;variant.versionName&#125;.apk"</span>)</span><br><span class="line">              	output.outputFile = apkFile</span><br><span class="line">      		&#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="为不同版本添加不同代码"><a href="#为不同版本添加不同代码" class="headerlink" title="为不同版本添加不同代码"></a>为不同版本添加不同代码</h4><p>buildTypes下的具体领域中，通过buildConfigField的三个参数，类型、名称、值，可以将一个变量设置到不同的buildType中去。</p>
<p>这些变量会生成在系统的BuildConfig中</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">buildConfigField <span class="string">"boolean"</span> <span class="string">"apkFlag"</span> <span class="string">"true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更改app的名称，可以放在buildTypes中，但是注意需要删除string.xml中的app_name字段，否则会冲突</span></span><br><span class="line">resValue(<span class="string">"string"</span>,<span class="string">"app_name"</span>,<span class="string">"hello_world"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="上传aar到Maven库"><a href="#上传aar到Maven库" class="headerlink" title="上传aar到Maven库"></a>上传aar到Maven库</h4><p>普通libriay的aar文件会存放在build/outputs/aar中</p>
<p>如果要上传aar到Maven库的话，是通过gradle脚本进行提交</p>
<p>具体脚本可以上网查询。</p>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><ul>
<li>check</li>
<li>assemble<ul>
<li>组合项目的所有输出，包含assembleDebug和assembleRelease两个Task</li>
</ul>
</li>
<li>build<ul>
<li>相当于check和assemble</li>
</ul>
</li>
<li>clean<ul>
<li>清理所有的中间编译结果</li>
</ul>
</li>
</ul>
<h2 id="Gradle依赖"><a href="#Gradle依赖" class="headerlink" title="Gradle依赖"></a>Gradle依赖</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查依赖关系</span></span><br><span class="line">gradle androidDependencies</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭项目的依赖传递</span></span><br><span class="line">compile <span class="string">'com.xxx.xxxxx:xxxxx:1.0.0-SNAPSHOT@aar'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以使用exclude module排除一个库中引用的其他库</span></span><br><span class="line">compule(<span class="string">'xxxx'</span>)&#123;</span><br><span class="line">  	exclude <span class="string">module:</span><span class="string">'com.xxx.asdfa'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Gradle编译加速"><a href="#Gradle编译加速" class="headerlink" title="Gradle编译加速"></a>Gradle编译加速</h2><p>Gradle本身已经内置了性能分析工具profile</p>
<p>build的时候只需要增加profile参数即可执行以下脚本</p>
<p>执行后在根目录的build/reports目录下会生成profile文件，里面有各项耗时</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle build --profile</span><br></pre></td></tr></table></figure>
<h3 id="关闭Lint"><a href="#关闭Lint" class="headerlink" title="关闭Lint"></a>关闭Lint</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 命令行</span><br><span class="line">gradle build -x lint</span><br><span class="line"></span><br><span class="line">// 脚本中动态增加编译参数</span><br><span class="line">project.gradle.startParameter.excludedTaskNames.add(&apos;lint&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="Gradle加速"><a href="#Gradle加速" class="headerlink" title="Gradle加速"></a>Gradle加速</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//gradle.properties,开启多线程和多核心支持</span><br><span class="line">org.gradle.daemon = true</span><br><span class="line">org.gradle.parallel = true</span><br><span class="line">org.gradle.configureondemand = true</span><br><span class="line"></span><br><span class="line">//build.gradle，开启增量编译，内存资源增加</span><br><span class="line">dexOptions&#123;</span><br><span class="line">	incremental </span><br><span class="line">  	javaMaxHeapSize &quot;4g&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义插件"><a href="#自定义插件" class="headerlink" title="自定义插件"></a>自定义插件</h2><p>创建自定义插件的三种方式：</p>
<ul>
<li>在build.gradle脚本中直接使用</li>
<li>buildSrc中使用</li>
<li>独立Module中使用</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hgworts.tech/2017/05/07/AndroidIPC机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hgDendi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HgWorts">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/07/AndroidIPC机制/" itemprop="url">Android的IPC机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-07T00:00:00+08:00">
                2017-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h1 id="IPC机制"><a href="#IPC机制" class="headerlink" title="IPC机制"></a>IPC机制</h1><h2 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h2><blockquote>
<p><strong>IPC</strong>         InterProcess Communication</p>
<p><strong>RPC</strong>     Remote Procedure Call</p>
</blockquote>
<p>Android默认每个app是一个进程，但也可以通过android:process属性使每个app有多个进程，或者多个app共享某个进程。</p>
<p>有时候通过多进程的方式获取多份内存空间。一般是指定android:process属性，还有一种非常规的方法，通过JNI在native层去fork一个新的进程。</p>
<ul>
<li>进程名以”:“开头的进程属于当前应用的<strong>私有进程</strong>，其他应用的组件不可以和它跑在一个进程中</li>
<li>进程名不以 “:” 开头的程序属于<strong>全局进程</strong>，其他应用通过ShareUID方式可以和它跑在同一个进程中。<ul>
<li>如果两个应用需要通过ShareUID跑在同一个进程，需要这两个应用有相同的ShareUID并且签名相同才可以</li>
<li>在这种情况下，可以互相访问对方的私有数据，比如data目录、组件信息等，当然还可以共享内存数据</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:process = ":remote"</span><br><span class="line">android:process = "com.dendi.helloworld.remote"</span><br></pre></td></tr></table></figure>
<h3 id="多进程的特性"><a href="#多进程的特性" class="headerlink" title="多进程的特性"></a>多进程的特性</h3><blockquote>
<p>Android为每个进程都分配一个独立的虚拟机，在内存分配上有不同的地址空间，这就导致了在不同的虚拟机中访问一个类的对象会产生多份副本</p>
<p>故而多进程的APP会拥有独立的虚拟机、Application以及内存空间。</p>
<p>相当于两个不同的应用采用了SharedUID的模式（Android系统为每个应用分配一个唯一的UID，具有相同UID的应用才能共享数据）</p>
</blockquote>
<ul>
<li>不同的内存空间，数据无法共享</li>
<li>需要谨慎处理代码中的线程同步</li>
<li>需要提防多进程并发导致的文件锁和数据库锁时效的问题</li>
</ul>
<p>具体问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 静态成员和单例模式完全失效</span><br><span class="line">2. 线程同步机制失效</span><br><span class="line">3. SharedPreferences可靠性下降(底层通过操作XML文件实现，并发写显然容易出问题)</span><br><span class="line">4. Application会多次重建</span><br></pre></td></tr></table></figure>
<h2 id="三个基础知识"><a href="#三个基础知识" class="headerlink" title="三个基础知识"></a>三个基础知识</h2><h3 id="Serializable"><a href="#Serializable" class="headerlink" title="Serializable"></a>Serializable</h3><p>Serializable使用简单但是开销很大，序列化和反序列化过程需要大量的IO操作，一般用于将对象序列化到<strong>存储设备</strong>中或者将对象序列化后通过<strong>网络传输</strong>。</p>
<p>可以通过ObjectOutputStream和ObjectInputStream轻松实现。</p>
<p>其中serialVersionUID的作用的辅助序列化和反序列化，原则上序列化后的数据中的serialVersionUID只有和当前类的相同才能够被正常的反序列化。</p>
<p>静态变量和用transient关键字标记的成员变量不参与序列化的过程。</p>
<h3 id="Parcelable"><a href="#Parcelable" class="headerlink" title="Parcelable"></a>Parcelable</h3><p>Parcelable使用麻烦，但效率很高。</p>
<ul>
<li>序列化    writeToParcel</li>
<li>反序列化 CREATOR</li>
<li>内容描述符 describeContents<ul>
<li>都应该返回0</li>
<li>对象中存在文件描述符时，返回1</li>
</ul>
</li>
</ul>
<h3 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h3><p>binder是Android中的一种跨进程通信方式.</p>
<p>可以理解为一种<strong>虚拟的物理设备</strong>，它的设备驱动是/dev/binder.</p>
<p>从Android Framework角度来说，Binder是ServiceManager连接各种Manager和相应ManagerService的桥梁。</p>
<p>从Android应用层来说，Binder是客户端和服务端进行通信的媒介。当bindService的时候，服务端会返回一个包含了服务端业务调用的Binder对象，通过这个Binder对象，客户端就可以获取服务端提供的服务或者数据，这里的服务包括<strong>普通服务</strong>和<strong>基于AIDL</strong>的服务。</p>
<blockquote>
<p>Binder更安全，比如socket的ip地址可以进行伪造，而Binder机制从协议本身就支持对通信双方做身份校验，因而大大提升了安全性，这个也是Android权限模型的基础。</p>
</blockquote>
<p><img src="http://upload-images.jianshu.io/upload_images/454052-af085ffaf33054ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Binder通信模型"></p>
<p>如下图，伪装。即<strong>代理模式</strong>。对代理对象的操作会通过驱动最终转发到Binder本地对象上去完成，当然使用者无需关心这些细节。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/454052-f45493b4121cd3b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Binder伪装"></p>
<p>Binder对象是一个可以跨进程引用的对象，它的实体位于一个进程中，它的引用却遍布于系统的各个进程中。最诱人的是，这个引用和java里引用一样既可以是强类型，也可以是弱类型，而且可以从一个进程传给另一个进程，让大家都能访问同一Server，就像一个对象或引用赋值给另一个引用一样。Binder<strong>模糊了进程边界</strong>，淡化了进程间通信过程，<strong>整个系统仿佛运行于同一个面向对象的程序之中</strong>。</p>
<p>AILD的本质是系统为我们提供了一种快速实现Binder的工具，仅此而已。</p>
<h4 id="Service中的Binder"><a href="#Service中的Binder" class="headerlink" title="Service中的Binder"></a>Service中的Binder</h4><p>Android中Binder主要用在Service中，包括AIDL和messager（Messager底层实际就是AIDL）</p>
<h4 id="为什么是Binder"><a href="#为什么是Binder" class="headerlink" title="为什么是Binder"></a>为什么是Binder</h4><ul>
<li>可靠性<ul>
<li>若在底层架设一套协议来实现Clinet-Service通信，增加了系统的复杂性</li>
<li>在资源有限的手机上实现复杂环境，可靠性难以保证</li>
</ul>
</li>
<li>传输性能<ul>
<li>Socket主要用于跨网络的进程间通信和本级上的进程间的通信，传输效率低，开销大</li>
<li>消息队列和管道采用存储-转发格式，数据先从发送方缓存区拷贝到内核开辟的一块缓存区中，然后从内核缓存区拷贝到接收方缓存区，其过程至少有两次拷贝。</li>
<li>共享内存无需拷贝但是控制复杂。</li>
<li>IPC方式的数据拷贝次数，共享内存0次，Binder1次，Socket/管道/消息队列 2次。</li>
</ul>
</li>
<li>安全性</li>
</ul>
<h2 id="IPC方式"><a href="#IPC方式" class="headerlink" title="IPC方式"></a>IPC方式</h2><blockquote>
<p>摘自任玉刚的《把玩Android多进程》ppt</p>
</blockquote>
<p><img src="https://ww4.sinaimg.cn/large/006tNc79gw1fbi70eu93yj31kc0wqgxp.jpg" alt="Screen Shot 2017-01-07 at 16.37.37"></p>
<h3 id="Bundle"><a href="#Bundle" class="headerlink" title="Bundle"></a>Bundle</h3><p>可以在一个进程中启动另一个进程的Activity、Service、Receiver</p>
<h3 id="文件共享"><a href="#文件共享" class="headerlink" title="文件共享"></a>文件共享</h3><p>适合在对数据同步要求不高的进程之间进行通信，并且要妥善处理好并发读、写的问题。</p>
<p>SharedPreferences因为系统对它的读写有有一定的缓存策略，即在内存中会有一份SharedPreferences文件的缓存，因此在多进程模式下，系统对它的读、写就变得不可靠。</p>
<h3 id="Messenger"><a href="#Messenger" class="headerlink" title="Messenger"></a>Messenger</h3><p>可以在不同进程中传递Message对象，在Message中放入我们需要传递的数据。</p>
<p>是一种轻量级的IPC方案，底层实现是AIDL。</p>
<p>一次只处理一个请求，因此在服务端我们<strong>不用考虑线程同步</strong>的问题。</p>
<p>通过Messgenger来传递Message，能使用的载体只有what、arg1、arg2、Bundle和replayTo。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Messenger的构造方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line">Messenger(Handler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从服务端获得IBinder后初始化</span></span><br><span class="line">Messenger(IBinder);</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务端</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerService</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">  	<span class="keyword">private</span> Messenger mMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> Handler());</span><br><span class="line">  </span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">  	<span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span></span>&#123;</span><br><span class="line">      	<span class="keyword">return</span> mMessenger.getBinder();</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端</span></span><br><span class="line"><span class="keyword">private</span> mMessenger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection()&#123;</span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName className,IBinder service)</span></span>&#123;</span><br><span class="line">      	mMessenger = <span class="keyword">new</span> Messenger(service);</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onCreate()&#123;</span><br><span class="line">  	bindService(intent,mConnection,Context.BIND_AUTO_CREATE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AIDL"><a href="#AIDL" class="headerlink" title="AIDL"></a>AIDL</h3><p>使用步骤：</p>
<ul>
<li><p>服务端创建Service，实现AIDL接口,并在onBind中返回它</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Server实现AIDL接口</span></span><br><span class="line"><span class="keyword">private</span> Binder mBinder = <span class="keyword">new</span> IBookManager.Stub()&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span></span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> mBinder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端绑定Service，将服务端返回的Binder对象转换成AIDL接口所属的类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection()&#123;</span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName className,IBinder service)</span></span>&#123;</span><br><span class="line">      	IBookManager bookManager = IBookManager.Stub.asInterface(service);</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>需要注意：</p>
<ol>
<li><p>对象的跨进程传输本质上是反序列化的过程，通过Binder传递后的对象会是全新的对象，但是这些对象会有一个共同点，他们底层的Binder是同一个。</p>
<p>所以若要跨进程使用观察者模式，需要使用<strong>RemoteCallbackList</strong>。</p>
<p>这个类还有一个很有用的功能，就是当客户端进程终止后，能够自动移除客户端所注册的listener。</p>
</li>
<li><p>Binder是会意外死亡的</p>
<ul>
<li>给Binder设置DeathRecipient监听</li>
<li>在onServiceDisconnected中重连远程服务</li>
</ul>
</li>
<li><p>远程方法调用发生在binder线程池中，需要小心因为耗时操作导致本端阻塞</p>
</li>
<li><p>服务端验证客户端权限</p>
<ul>
<li>onBind中通过checkCallingOrsELFpermission(“permission”)检查客户端是否声明该权限</li>
<li>验证包名，getPackageManager().getPackagesForUid(getCallingUid())</li>
</ul>
</li>
</ol>
<h3 id="ContentProvider"><a href="#ContentProvider" class="headerlink" title="ContentProvider"></a>ContentProvider</h3><p>底层实现也是Binder,用于不同应用间进行数据共享的方式。</p>
<h4 id="创建一个ContentProvider"><a href="#创建一个ContentProvider" class="headerlink" title="创建一个ContentProvider"></a>创建一个ContentProvider</h4><p>创建一个自定义的ContentProvider需要继承ContentProvider并实现六个抽象方法：</p>
<p>另外，是存在多进程并发访问的，故而四大方法需要做好线程<strong>同步</strong>准备。</p>
<ul>
<li>onCreate<ul>
<li>代表ContentProvider的创建，做一些初始化的操作</li>
</ul>
</li>
<li>query</li>
<li>update</li>
<li>insert</li>
<li>delete</li>
<li>getType<ul>
<li>返回一个Uri请求所对应的MIME类型，比如图片或者视频等</li>
<li>不关注这个选项可以返回null或者“<em>/</em>”</li>
</ul>
</li>
</ul>
<p>需要注册：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">	<span class="attr">android:name</span> = <span class="string">".provider.BookProvider"</span></span></span><br><span class="line"><span class="tag">	//唯一标识</span></span><br><span class="line"><span class="tag">	<span class="attr">android:authorities</span>=<span class="string">"com.dendi.chapter.book.provider"</span></span></span><br><span class="line"><span class="tag">	//权限声明</span></span><br><span class="line"><span class="tag">	<span class="attr">android:permission</span>=<span class="string">"com.dendi.Provider"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>查询时</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Uri userUri = Uri.parse(<span class="string">"content://com.dendi.chapter.book.provider/user"</span>);</span><br><span class="line">Cursor userCursor = getContentResolver().query(</span><br><span class="line">  	userUri,<span class="keyword">new</span> String[]&#123;<span class="string">"_id"</span>,<span class="string">"name"</span>,<span class="string">"sex"</span>&#125;,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">while</span>(userCursor.moveToNext())&#123;</span><br><span class="line"> 	<span class="comment">//print</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h4><p>以<strong>表格</strong>的形式来组织数据</p>
<h3 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h3><ul>
<li>流式套接字<ul>
<li>TCP</li>
<li>面向连接，提供稳定的双向通信功能（本身提供了超时重传），有很高的稳定性</li>
</ul>
</li>
<li>用户数据报套接字<ul>
<li>UDP</li>
<li>无连接，提供不稳定的单向通信功能</li>
<li>效率更高，但是不能保证数据一定能够正确传输，尤其在网络拥塞的情况下</li>
</ul>
</li>
</ul>
<p>注意不要在UI线程中访问网络，会抛出异常。</p>
<p>另外Socket的ip地址是可以伪造的，故而不一定具有安全性。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hgworts.tech/2017/03/14/APP启动优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hgDendi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HgWorts">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/14/APP启动优化/" itemprop="url">APP启动优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-14T00:00:00+08:00">
                2017-03-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h1 id="APP启动优化"><a href="#APP启动优化" class="headerlink" title="APP启动优化"></a>APP启动优化</h1><h2 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h2><h3 id="冷启动"><a href="#冷启动" class="headerlink" title="冷启动"></a>冷启动</h3><blockquote>
<p>后台没有该应用的进程，这时系统会重新创建一个新的进程分配给该应用，这个启动方式就是冷启动。</p>
</blockquote>
<p>application以及activity初始化是一个比较复杂的过程，而白屏或黑屏就是这个过程的产物。</p>
<p>在应用程序刚启动到应用程序初始化完全之间有一段时间空隙，这时候系统创建了一个空白窗口，叫StartingWindow。这个窗口是一个临时窗口，对应的WindowType是TYPE_APPLICATION_STARTING。应用程序加载完第一帧后，这个窗口就会被移除。</p>
<p>Window的顶层是DecorView，所以StartingWindow显示一个空DecorView，但是会给这个DecorView应用当前Activity指定的Theme，如果这个activity没有指定Theme就用application的，如果Theme是白色的，屏幕就是白色的；如果是Dark，就会显示黑屏。</p>
<h3 id="热启动"><a href="#热启动" class="headerlink" title="热启动"></a>热启动</h3><blockquote>
<p> 后台已有该应用的进程(按back键、home键)</p>
</blockquote>
<p>热启动在直到应用完成渲染之前都会一直显示一个空白窗口。</p>
<h2 id="App启动过程"><a href="#App启动过程" class="headerlink" title="App启动过程"></a>App启动过程</h2><p>ActivityThread运行在应用进程的主线程上，响应AMS启动、暂停Activity，广播启动等消息。</p>
<p>AMS：统一调度各应用程序的Activity、内存管理、进程管理</p>
<ol>
<li>点击Launcher，启动程序，通知ActivityManagerService</li>
<li>AMS通知zygote进程孵化出应用进程，分配内存空间等</li>
<li>执行该应用ActivityThread的main方法</li>
<li>APP通知AMS，AMS保存一个该应用的代理对象，AMS通过它可以控制应用进程</li>
<li>AMS通知应用进程创建入口的Activity实例，执行它的生命周期<ul>
<li>Application的构造方法</li>
<li>attachBaseContext()</li>
<li>onCreate()</li>
<li>LauncherActivity的构造方法</li>
<li>setTheme()设置主题等信息</li>
<li>Activity的生命周期</li>
</ul>
</li>
</ol>
<h2 id="启动页优化"><a href="#启动页优化" class="headerlink" title="启动页优化"></a>启动页优化</h2><p>设置一个启动页SplashFragment进行过度。并在MainActivity中优先展示SplashFragment，显示完毕后再进行remove。当然MainActivity的主布局可以采用ViewStub进行懒加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span>&#123;</span><br><span class="line">  	setContentView();</span><br><span class="line">  	<span class="comment">//显示splashFragment</span></span><br><span class="line">  </span><br><span class="line">  	getWindow().getDecorView().post(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">      	<span class="comment">//渲染主界面，用队列</span></span><br><span class="line">      	viewStub.inflate();</span><br><span class="line">  	&#125;);</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">//等时间结束后，取消splashFragment，呈现主界面</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="评估"><a href="#评估" class="headerlink" title="评估"></a>评估</h2><ol>
<li><p>系统提供的启动时间方案</p>
<p>logcat的输出，关键字为Displayed</p>
</li>
<li><p>ADB命令提供的启动时间方案</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -w packagename/activity</span><br></pre></td></tr></table></figure>
<p>ThisTime:一连串启动的activity中的最后一个activity的启动耗时<br>TotalTime:新进程的Activity的启动耗时，但不包括前一个应用activity中pause()方法的耗时<br>WaitTime：总的耗时</p>
<p>一般情况下ThisTime和TotalTime耗时是相同的。有一个场景会导致这两个值不同，比如点击App图标，先启动一个无界面的activity做逻辑处理，接着又启动一个有界面的activity</p>
</li>
<li><p>利用TraceView进行分析</p>
<ul>
<li>使用方法<ul>
<li>AS中的startMethodTracing</li>
<li>代码中使用Debug.startMethodTracing(“xxx.trace”)和stop，然后sdcard下会生成trace文件</li>
</ul>
</li>
<li>最关心的数据<ul>
<li>Calls+Recur Calls / Total, 查找自身占用时间不长，但是调用频繁的操作</li>
<li>Cpu Time / Call , 某个函数消耗CPU的平均时间，一般用来查找调用次数不多，但每次调用却需要花费很长时间的方法</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="界面优化"><a href="#界面优化" class="headerlink" title="界面优化"></a>界面优化</h2><ol>
<li>尽量使用include、merge、ViewStub标签</li>
<li>不使用冗余嵌套和过于复杂布局</li>
<li>尽量使用GONE替换INVISIBLE</li>
<li>使用weight后尽量将width和height设置为0</li>
<li>item存在复杂嵌套关系时用自定义View替代，减少measure与layout次数</li>
<li>主题上使用windowbackground为启动Activty设置简单的自定义Drawable</li>
<li>第三方SDK在使用到的地方再进行初始化</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hgworts.tech/2017/02/21/Android事件分发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hgDendi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HgWorts">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/21/Android事件分发/" itemprop="url">Android事件分发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-21T00:00:00+08:00">
                2017-02-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<p>参考：</p>
<p><a href="http://www.jianshu.com/p/e99b5e8bd67b" target="_blank" rel="noopener">Kelin的图解Android事件分发机制</a></p>
<p><a href="http://www.jianshu.com/p/3d60abc897c7" target="_blank" rel="noopener">源码解读</a></p>
<h2 id="概览（以ACTION-DOWN为例"><a href="#概览（以ACTION-DOWN为例" class="headerlink" title="概览（以ACTION_DOWN为例)"></a>概览（以ACTION_DOWN为例)</h2><p><img src="http://upload-images.jianshu.io/upload_images/966283-b9cb65aceea9219b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="分发流程图"></p>
<p>从上到下依次为Activity、ViewGroup、View</p>
<ol>
<li>dispatchTouchEvent和onTouchEvent一旦返回true，事件就停止传递了</li>
<li>dispatchTouchEvent和onTouchEvent返回false，都会回传给父控件的onTouchEvent处理（其中Activity会终止）</li>
</ol>
<blockquote>
<p>但其实调用顺序完整的说法应该是</p>
<p>Activity&gt;PhoneWindow&gt;DecorView&gt;ViewGroup&gt;View</p>
</blockquote>
<h3 id="onTouch"><a href="#onTouch" class="headerlink" title="onTouch"></a>onTouch</h3><p>dispatchTouchEvent相当于onTouch</p>
<p>这几个方法的优先级是onTouch&gt;onTouchEvent&gt;onClick</p>
<p>onTouch返回true，相当于dispatchTouchEvent返回true</p>
<p>而onClick是在onTouchEvent中调用的</p>
<h2 id="关于ACTION-MOVE和ACTION-UP"><a href="#关于ACTION-MOVE和ACTION-UP" class="headerlink" title="关于ACTION_MOVE和ACTION_UP"></a>关于ACTION_MOVE和ACTION_UP</h2><ul>
<li>当dispatchTouchEvent进行事件分发的时候，只有前一个事件（如ACTION_DOWN)返回true，才会收到MOVE和UP的事件。且一个View一旦决定拦截事件，那么这一个事件序列都由它来处理，而不会再调用onInterceptTouchEvent了</li>
<li>如果在某个控件的dispatchTouchEvent返回true消费事件，那么收到ACTION_DOWN的函数也能收到ACTION_MOVE和ACTION_UP</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/966283-f1d9edbc21e955c8.png?imageMogr2/auto-orient/strip%7CimageView2/2" alt="事件消费"></p>
<ul>
<li>如果我们在onTouchEvent中消费了事件，那么MOVE和UP事件从上往下传到这个View后就不再往下传递了，而直接传给自己的onTouchEvent并结束本次事件传递过程</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/966283-e78685608fced6a0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="事件分发"></p>
<h2 id="结合代码分析"><a href="#结合代码分析" class="headerlink" title="结合代码分析"></a>结合代码分析</h2><h3 id="dispatchTouchEvent"><a href="#dispatchTouchEvent" class="headerlink" title="dispatchTouchEvent"></a>dispatchTouchEvent</h3><h4 id="Activity-dispatchTouchEvent"><a href="#Activity-dispatchTouchEvent" class="headerlink" title="Activity#dispatchTouchEvent"></a>Activity#dispatchTouchEvent</h4><ol>
<li>Activity调用了window的dispatchTouchEvent</li>
<li>window调用了mDecor的dispatchTouchEvent</li>
<li>mDecor调用了super即FrameLayout的dispatchTouchEvent</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">        onUserInteraction();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> onTouchEvent(ev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ViewGroup-dispatchTouchEvent"><a href="#ViewGroup-dispatchTouchEvent" class="headerlink" title="ViewGroup#dispatchTouchEvent"></a>ViewGroup#dispatchTouchEvent</h4><h6 id="伪代码实现"><a href="#伪代码实现" class="headerlink" title="伪代码实现"></a>伪代码实现</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;             <span class="comment">// 默认状态为没有消费过</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!onInterceptTouchEvent(ev)) &#123;   <span class="comment">// 如果没有拦截交给子View</span></span><br><span class="line">        result = child.dispatchTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result) &#123;                      <span class="comment">// 如果事件没有被消费,询问自身onTouchEvent</span></span><br><span class="line">        result = onTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="真实代码"><a href="#真实代码" class="headerlink" title="真实代码"></a>真实代码</h6><ol>
<li>首先判断是否需要调用onInterceptTouchEvent，mFirstTouchTarget在事件不被拦截并且交给子元素处理时不为空，即有子View处理事件时，此值不为空</li>
<li>disallowIntercept由子View的requestDisallowInterceptTouchEvent决定，但是这个对ACTION_DOWN无效，因为在dispatchTouchEvent开头会重置。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check for interception</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</span><br><span class="line"><span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                    || mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">        intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">        ev.setAction(action); <span class="comment">// restore action in case it was changed</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        intercepted = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// There are no touch targets and this action is not an initial down</span></span><br><span class="line">    <span class="comment">// so this view group continues to intercept touches.</span></span><br><span class="line">    intercepted = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>接下来遍历子View，满足：</p>
<ul>
<li>没有进行动画</li>
<li>点击的位置在View的坐标范围内的View会被调用dispatchTouchEvent</li>
</ul>
</li>
</ol>
<h4 id="View-dispatchTouchEvent"><a href="#View-dispatchTouchEvent" class="headerlink" title="View#dispatchTouchEvent"></a>View#dispatchTouchEvent</h4><p>调用步骤：</p>
<ol>
<li>onTouch（注意View是disabled的话，只要是clickable或者longclickable仍然可以消费点击事件，只是不会生效）</li>
<li>onTouchEvent</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">            ListenerInfo li = mListenerInfo;</span><br><span class="line">            <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">                    &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hgworts.tech/2017/02/12/人生苦短，我用Python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hgDendi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HgWorts">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/12/人生苦短，我用Python/" itemprop="url">人生苦短，我用python</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-12T00:00:00+08:00">
                2017-02-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="人生苦短，我用Python"><a href="#人生苦短，我用Python" class="headerlink" title="人生苦短，我用Python"></a>人生苦短，我用Python</h1><p><a href="http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001431929340191970154d52b9d484b88a7b343708fcc60000" target="_blank" rel="noopener">廖雪峰的个人网站</a></p>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><ol>
<li>运行速度慢</li>
<li>代码不能加密（解释型语言）</li>
</ol>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><p>py变量本身类型不固定，是一门<strong>动态语言</strong>，一个变量可以被赋值成不同类型。</p>
<p>比如之前为int，后来为string</p>
<p>判断常量类型可以使用isinstance(x, (int, float))</p>
<h4 id="命名规则"><a href="#命名规则" class="headerlink" title="命名规则"></a>命名规则</h4><ul>
<li>常量<ul>
<li>全大写</li>
</ul>
</li>
</ul>
<h4 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># output</span></span><br><span class="line"><span class="comment"># py中使用r''表示括号中的东西不转义</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"%s %d"</span> % (<span class="string">""</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># input</span></span><br><span class="line">user = raw_input(<span class="string">"Enter your name:"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># getHelp</span></span><br><span class="line">help(funcName)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Maths</span></span><br><span class="line"><span class="comment"># / 普通除法，结果会是浮点数</span></span><br><span class="line"><span class="comment"># // 地板除法，结果不一定</span></span><br><span class="line"><span class="comment"># ** 双星号</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 空值 None</span></span><br><span class="line">name = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># and or not </span></span><br><span class="line"><span class="number">5</span> &gt; <span class="number">3</span> <span class="keyword">and</span> <span class="number">3</span> &gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#string</span></span><br><span class="line">string[index]</span><br><span class="line">string[start:end]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#if</span></span><br><span class="line"><span class="keyword">if</span> expression:</span><br><span class="line">    if_suite</span><br><span class="line"><span class="keyword">elif</span> expression:</span><br><span class="line">    elif_suite</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    else_suite</span><br><span class="line"></span><br><span class="line"><span class="comment">#for iterable</span></span><br><span class="line"><span class="keyword">for</span> XX <span class="keyword">in</span> dict|str|list|set|tuple|generator:</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> aDict.items()</span><br><span class="line"></span><br><span class="line"><span class="comment">#while </span></span><br><span class="line"><span class="keyword">while</span> expression:</span><br></pre></td></tr></table></figure>
<p>变量不需要预先声明类型，在赋值的那一刻被初始化。</p>
<h4 id="字符编码"><a href="#字符编码" class="headerlink" title="字符编码"></a>字符编码</h4><ul>
<li>UNICODE<ul>
<li>把所有语言都统一到一套编码里</li>
<li>通常2个字节</li>
<li>计算机内存中统一使用UNICODE编码，按需进行转换</li>
</ul>
</li>
<li>ASCII<ul>
<li>1个字节，通常用来保存英文</li>
</ul>
</li>
<li>UTF-8<ul>
<li>英文字符1个字节，中文字符3个字节</li>
<li>有一个额外的好处，ASCII编码可以看成是UTF8编码的一部分</li>
</ul>
</li>
</ul>
<h4 id="list"><a href="#list" class="headerlink" title="list"></a>list</h4><p>方括号</p>
<p>有序的集合，可以随时添加和删除其中的元素。 元素可以是任意元素</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">aList = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"><span class="comment">#取最后一个元素可以用-1</span></span><br><span class="line">aList[<span class="number">-1</span>]</span><br><span class="line"><span class="comment">#insert</span></span><br><span class="line">aList.append()</span><br><span class="line">aList.insert(<span class="number">1</span>,<span class="string">'hello'</span>)</span><br><span class="line"><span class="comment">#pop</span></span><br><span class="line">aList.pop()</span><br><span class="line">aList.pop(int)</span><br><span class="line"></span><br><span class="line"><span class="comment">#列表生成</span></span><br><span class="line"><span class="comment">#使用list函数</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(range(<span class="number">1</span>, <span class="number">11</span>))</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br><span class="line"><span class="comment"># 循环生成</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[x * x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">11</span>)]</span><br><span class="line">[<span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>, <span class="number">36</span>, <span class="number">49</span>, <span class="number">64</span>, <span class="number">81</span>, <span class="number">100</span>]</span><br><span class="line"><span class="comment"># 全排列</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[m + n <span class="keyword">for</span> m <span class="keyword">in</span> <span class="string">'ABC'</span> <span class="keyword">for</span> n <span class="keyword">in</span> <span class="string">'XYZ'</span>]</span><br><span class="line">[<span class="string">'AX'</span>, <span class="string">'AY'</span>, <span class="string">'AZ'</span>, <span class="string">'BX'</span>, <span class="string">'BY'</span>, <span class="string">'BZ'</span>, <span class="string">'CX'</span>, <span class="string">'CY'</span>, <span class="string">'CZ'</span>]</span><br></pre></td></tr></table></figure>
<p>扩展：generator</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列表生成的[]改为()</span></span><br><span class="line">g = (x * x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">11</span>))</span><br><span class="line"><span class="comment">#记录生成算法，需要的时候再进行计算</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> g:</span><br><span class="line">    print(g)</span><br><span class="line">next(g)</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果一个函数中包含yield关键字，这个函数就是一个generator</span></span><br><span class="line"><span class="comment">#generator的函数在每次调用next()的时候执行，遇到yield语句返回，再次执行时从上次返回的yield语句处继续执行</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(max)</span>:</span></span><br><span class="line">    n, a, b = <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; max:</span><br><span class="line">        <span class="keyword">yield</span> b</span><br><span class="line">        a, b = b, a + b</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'done'</span></span><br><span class="line"><span class="comment">#next可能跑出StopIteration错误，需要捕获</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">    	XXX</span><br><span class="line">	<span class="keyword">except</span> StopIteration <span class="keyword">as</span> e:</span><br><span class="line">    	print(<span class="string">"generator return value"</span>,e.value)</span><br><span class="line">    	<span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">finally</span>:</span><br></pre></td></tr></table></figure>
<h4 id="Tuple"><a href="#Tuple" class="headerlink" title="Tuple"></a>Tuple</h4><p>圆括号，不可更改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 元组不可以被更改(内容可以)</span></span><br><span class="line">aTuple = (<span class="string">'robot'</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="comment"># 定义一个元素的tuple需要加逗号,否则t就是1这个数了</span></span><br><span class="line">t = (<span class="number">1</span>,)</span><br></pre></td></tr></table></figure>
<h4 id="字典dict（Map）"><a href="#字典dict（Map）" class="headerlink" title="字典dict（Map）"></a>字典dict（Map）</h4><p>大括号</p>
<p>注意key是不可变的（字符串、整数）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">aDict = &#123;<span class="string">'host'</span>:<span class="string">'earth'</span>&#125;</span><br><span class="line">aDict[<span class="string">'port'</span>]=<span class="number">80</span></span><br><span class="line">aDict.keys()</span><br><span class="line">aDict[<span class="string">'port'</span>]</span><br><span class="line"><span class="comment"># 判断是否in</span></span><br><span class="line"><span class="string">'port'</span> <span class="keyword">in</span> aDict</span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">aDict.pop(<span class="string">''</span>)</span><br></pre></td></tr></table></figure>
<h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><p>是一组key的集合，且key不能重复</p>
<p>需要提供一个list作为输入集合，会自动过滤重复项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s = set([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br><span class="line">s.add()</span><br><span class="line">s.remove()</span><br><span class="line"><span class="comment">#可以做数学意义上的&amp; |</span></span><br></pre></td></tr></table></figure>
<h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassName</span><span class="params">(base_class[es])</span>:</span></span><br><span class="line">	<span class="string">"optional documentation string"</span></span><br><span class="line">    static_member_declarations</span><br><span class="line">    method_declarations</span><br><span class="line">    </span><br><span class="line"><span class="comment">#example</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FooClass</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"test"</span></span><br><span class="line">    version = <span class="number">0.1</span></span><br><span class="line"><span class="comment">#invoke after construction,self = this</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,nm=<span class="string">'Hg Dendi'</span>)</span>:</span></span><br><span class="line">    func_suite</span><br><span class="line">    </span><br><span class="line"><span class="comment">#etc</span></span><br><span class="line"></span><br><span class="line">dendi = Student();</span><br></pre></td></tr></table></figure>
<h5 id="slots"><a href="#slots" class="headerlink" title="slots"></a>slots</h5><p>可以动态给对象或类绑定属性和方法</p>
<p>slots表示限制对象的属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></span><br><span class="line">    __slots__ = (<span class="string">'name'</span>, <span class="string">'age'</span>) <span class="comment"># 用tuple定义允许绑定的属性名称</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># property 表示可以通过属性访问</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">	@property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">score</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._score</span><br><span class="line"></span><br><span class="line"><span class="meta">    @score.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">score</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, int):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'score must be an integer!'</span>)</span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span> <span class="keyword">or</span> value &gt; <span class="number">100</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'score must between 0 ~ 100!'</span>)</span><br><span class="line">        self._score = value</span><br><span class="line">        </span><br><span class="line">s  = Student()</span><br><span class="line">s.score = <span class="number">100</span></span><br></pre></td></tr></table></figure>
<h4 id="Enum"><a href="#Enum" class="headerlink" title="Enum"></a>Enum</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 </span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line">Month = Enum(<span class="string">'Month'</span>, (<span class="string">'Jan'</span>, <span class="string">'Feb'</span>, <span class="string">'Mar'</span>, <span class="string">'Apr'</span>, <span class="string">'May'</span>, <span class="string">'Jun'</span>, <span class="string">'Jul'</span>, <span class="string">'Aug'</span>, <span class="string">'Sep'</span>, <span class="string">'Oct'</span>, <span class="string">'Nov'</span>, <span class="string">'Dec'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 子类继承Enum</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum, unique</span><br><span class="line"></span><br><span class="line"><span class="meta">@unique</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Weekday</span><span class="params">(Enum)</span>:</span></span><br><span class="line">    Sun = <span class="number">0</span> <span class="comment"># Sun的value被设定为0</span></span><br><span class="line">    Mon = <span class="number">1</span></span><br><span class="line">    Tue = <span class="number">2</span></span><br><span class="line">    Wed = <span class="number">3</span></span><br><span class="line">    Thu = <span class="number">4</span></span><br><span class="line">    Fri = <span class="number">5</span></span><br><span class="line">    Sat = <span class="number">6</span></span><br><span class="line">    </span><br><span class="line">day1 = Weekday.Mon</span><br></pre></td></tr></table></figure>
<h5 id="metaclass"><a href="#metaclass" class="headerlink" title="metaclass"></a>metaclass</h5><p>控制类的创建行为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListMetaclass</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></span><br><span class="line">        attrs[<span class="string">'add'</span>] = <span class="keyword">lambda</span> self, value: self.append(value)</span><br><span class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyList</span><span class="params">(list, metaclass=ListMetaclass)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>L = MyList()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>L.add(<span class="number">1</span>)</span><br><span class="line">&gt;&gt; L</span><br><span class="line">[<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<h4 id="标识符"><a href="#标识符" class="headerlink" title="标识符"></a>标识符</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_xxx_	系统定义、特殊变量，可以被直接饮用</span><br><span class="line">_xxx	private</span><br></pre></td></tr></table></figure>
<h4 id="build-in-func"><a href="#build-in-func" class="headerlink" title="build-in func"></a>build-in func</h4><table>
<thead>
<tr>
<th>Func</th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td>operator.eq()</td>
<td style="text-align:center">Compare</td>
</tr>
<tr>
<td>str(obj)</td>
<td style="text-align:center">get description</td>
</tr>
<tr>
<td>type(obj)</td>
<td style="text-align:center">getType</td>
</tr>
<tr>
<td>repr(obj)  or. ‘obj’</td>
<td style="text-align:center">字符串表示</td>
</tr>
<tr>
<td>ord(char)</td>
<td style="text-align:center">字符的证书表示</td>
</tr>
<tr>
<td>chr(int)</td>
<td style="text-align:center">整数对应的char</td>
</tr>
<tr>
<td>isinstance(x, str)</td>
<td style="text-align:center">判断前者是不是后者的类型</td>
</tr>
<tr>
<td>map(func,list)</td>
<td style="text-align:center">将list中的元素通过func进行转换</td>
</tr>
<tr>
<td>reduce(func,list)</td>
<td style="text-align:center">将list中的元素通过func进行减少</td>
</tr>
<tr>
<td>filter(func,list)</td>
<td style="text-align:center">根据func指示的布尔值进行过滤，返回Iterator，一般需要list（）</td>
</tr>
<tr>
<td>sorted(list,key=func,reverse = bool)</td>
<td style="text-align:center">排序,根据key的大小排序</td>
</tr>
<tr>
<td>dir()</td>
<td style="text-align:center">一个对象所有的方法</td>
</tr>
<tr>
<td></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p><a href="https://docs.python.org/3/library/functions.html#abs" target="_blank" rel="noopener">buildInFunc</a></p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># annotation &amp; func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">function_name</span><span class="params">([arguments])</span>:</span></span><br><span class="line">    <span class="string">"optional documentation string."</span></span><br><span class="line">    function_suite</span><br><span class="line">    </span><br><span class="line"><span class="comment">#etc</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_abs</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> x&gt;=<span class="number">0</span>:</span><br><span class="line">    	<span class="keyword">return</span> x</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> -x</span><br><span class="line">    </span><br><span class="line"><span class="comment">#可以使用默认参数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">power</span><span class="params">(a,b=<span class="number">2</span>)</span>:</span></span><br><span class="line">	do sth</span><br><span class="line"><span class="comment">#默认参数必须指向不变对象！否则多次执行会出现问题</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_end</span><span class="params">(L=[])</span>:</span></span><br><span class="line">    L.append(<span class="string">'END'</span>)</span><br><span class="line">    <span class="keyword">return</span> L</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add_end()</span><br><span class="line">[<span class="string">'END'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add_end()</span><br><span class="line">[<span class="string">'END'</span>, <span class="string">'END'</span>]</span><br><span class="line">    </span><br><span class="line"><span class="comment">#可变参数,传入0个或任意个参数，在调用时自动组装为tuple</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cal</span><span class="params">(*numbers)</span>:</span></span><br><span class="line">    sum = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> numbers:</span><br><span class="line">        sum = sum + n*n</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line"></span><br><span class="line">cal(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">cal(<span class="number">0</span>)</span><br><span class="line">aList = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">cal(*aList)</span><br><span class="line"></span><br><span class="line"><span class="comment">#关键字参数，传入任意个含参数名的参数，在函数内部自动组装为一个dict</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">person</span><span class="params">(name, age, **kw)</span>:</span></span><br><span class="line">    print(<span class="string">'name:'</span>, name, <span class="string">'age:'</span>, age, <span class="string">'other:'</span>, kw)</span><br><span class="line">    </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'Bob'</span>, <span class="number">35</span>, city=<span class="string">'Beijing'</span>)</span><br><span class="line">name: Bob age: <span class="number">35</span> other: &#123;<span class="string">'city'</span>: <span class="string">'Beijing'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'Adam'</span>, <span class="number">45</span>, gender=<span class="string">'M'</span>, job=<span class="string">'Engineer'</span>)</span><br><span class="line">name: Adam age: <span class="number">45</span> other: &#123;<span class="string">'gender'</span>: <span class="string">'M'</span>, <span class="string">'job'</span>: <span class="string">'Engineer'</span>&#125;</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 命名关键字参数</span></span><br><span class="line"><span class="comment"># 限制关键字参数的名字，比如只接受city和job作为关键字参数</span></span><br><span class="line"><span class="comment"># 命名关键字参数需要一个特殊分隔符*，*后面的参数被视为命名参数关键字</span></span><br><span class="line"><span class="comment"># 可变参数后不需要再额外加*，默认变为关键字参数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">person</span><span class="params">(name,age,*,city=“Beijing”,job)</span></span></span><br><span class="line"><span class="function">	<span class="title">print</span><span class="params">(name,age,city,job)</span></span></span><br></pre></td></tr></table></figure>
<p>需要注意，默认参数必须指向不变对象，否则会出现默认参数更改后，之后再次调用函数的默认参数为之前更改过的对象。</p>
<h5 id="懒加载函数"><a href="#懒加载函数" class="headerlink" title="懒加载函数"></a>懒加载函数</h5><p> 比如不需要立即求和，而是在后面的代码中根据需要再进行计算</p>
<p>注意返回的函数不要引用循环变量，或者后续会发生变化的变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lazy_sum</span><span class="params">(*args)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sum</span><span class="params">()</span>:</span></span><br><span class="line">        ax = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> args:</span><br><span class="line">            ax = ax + n</span><br><span class="line">        <span class="keyword">return</span> ax</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line">f = lazy_sum(<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>)</span><br><span class="line">f()</span><br></pre></td></tr></table></figure>
<h5 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lambda</span> x:x*x</span><br><span class="line"><span class="comment">#就是</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> x*x</span><br></pre></td></tr></table></figure>
<h5 id="wrapper"><a href="#wrapper" class="headerlink" title="wrapper"></a>wrapper</h5><p>函数也有对象，可以拿到属性.</p>
<p>若想在代码运行期间增加功能，称为装饰器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="comment"># 使wrapper和func的__name__相同</span></span><br><span class="line"><span class="meta">    @functools.wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kw)</span>:</span></span><br><span class="line">        print(<span class="string">'call %s():'</span> % func.__name__)</span><br><span class="line">        <span class="keyword">return</span> func(*args,**kw)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="comment">#相当于执行了now = log(now)</span></span><br><span class="line"><span class="meta">@log</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	<span class="title">print</span><span class="params">(<span class="string">"2017-01-01"</span>)</span></span></span><br><span class="line"><span class="function">#通过属性拿到函数名'<span class="title">now</span>'</span></span><br><span class="line"><span class="function"><span class="title">now</span>.<span class="title">__name__</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#三层嵌套，可以<span class="title">log</span>加参数</span></span><br><span class="line"><span class="function"><span class="title">def</span> <span class="title">log</span><span class="params">(text)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">        @functools.wraps(func)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">            print(<span class="string">'%s %s():'</span> % (text, func.__name__))</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kw)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="comment">#相当于now = log('execute')(now)</span></span><br><span class="line"><span class="meta">@log('execute')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'2015-3-25'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="偏函数"><a href="#偏函数" class="headerlink" title="偏函数"></a>偏函数</h5><p>把一个函数的某个参数固定住</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line">int2 = functools.partial(int , base=<span class="number">2</span>)</span><br><span class="line">int2(<span class="string">'1000000'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h4><ol>
<li>ASCII 英语和数字，一个字节表示一个字符</li>
<li>Unicode 通常两个字节表示一个字符，特殊符号可能需要四个（Python3）</li>
<li>UTF-8 把字符编码成1-6个字节，汉字通常3个字节，英文字母1个字节</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br></pre></td></tr></table></figure>
<h4 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'//'</span>,<span class="string">'r'</span>,encoding=<span class="string">'gbk'</span>)</span><br><span class="line"><span class="comment">#更推荐用with来写</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">''</span>,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    do sth</span><br><span class="line"><span class="comment"># 无参即一次读完，可以调用read(size),readline()</span></span><br><span class="line">f.read()</span><br><span class="line">f.write(<span class="string">'error'</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<h4 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h4><p>Linux操作系统提供了一个fork()系统调用，调用一次，返回两次，因为操作系统把当前进程赋值了一份，即创建了一个子进程，故而分别在父进程和子进程内返回了。</p>
<p>其中子进程返回0，而父进程返回子进程的id。因为父进程可以fork出很多子进程，所以父进程要记下每个子进程的id，而子进程只需要调用getppid()就可以拿到父进程的ID</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Process (%s) start...'</span> % os.getpid())</span><br><span class="line"><span class="comment"># Only works on Unix/Linux/Mac:</span></span><br><span class="line">pid = os.fork()</span><br><span class="line"><span class="keyword">if</span> pid == <span class="number">0</span>:</span><br><span class="line">    print(<span class="string">'I am child process (%s) and my parent is %s.'</span> % (os.getpid(), os.getppid()))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'I (%s) just created a child process (%s).'</span> % (os.getpid(), pid))</span><br></pre></td></tr></table></figure>
<h5 id="multiprocessing"><a href="#multiprocessing" class="headerlink" title="multiprocessing"></a>multiprocessing</h5><p>因为windows没有fork，故而需要一个跨平台的多进程支持库</p>
<p>创建子进程时，只需要传入一个执行函数和函数的参数，创建一个Process实例，用start()方法启动。</p>
<p>join() 方法用于进程间的同步，表示等待子进程结束后再继续往下运行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子进程要执行的代码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_proc</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">'Run child process %s (%s)...'</span> % (name, os.getpid()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    print(<span class="string">'Parent process %s.'</span> % os.getpid())</span><br><span class="line">    p = Process(target=run_proc, args=(<span class="string">'test'</span>,))</span><br><span class="line">    print(<span class="string">'Child process will start.'</span>)</span><br><span class="line">    p.start()</span><br><span class="line">    p.join()</span><br><span class="line">    print(<span class="string">'Child process end.'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h5><p>大量启动子进程，可以用进程池的方式批量创建子进程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">import</span> os, time, random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">long_time_task</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">'Run task %s (%s)...'</span> % (name, os.getpid()))</span><br><span class="line">    start = time.time()</span><br><span class="line">    time.sleep(random.random() * <span class="number">3</span>)</span><br><span class="line">    end = time.time()</span><br><span class="line">    print(<span class="string">'Task %s runs %0.2f seconds.'</span> % (name, (end - start)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    print(<span class="string">'Parent process %s.'</span> % os.getpid())</span><br><span class="line">    <span class="comment">#pool默认大小为CPU的核数</span></span><br><span class="line">    p = Pool(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        p.apply_async(long_time_task, args=(i,))</span><br><span class="line">    print(<span class="string">'Waiting for all subprocesses done...'</span>)</span><br><span class="line">    p.close()</span><br><span class="line">    p.join()</span><br><span class="line">    print(<span class="string">'All subprocesses done.'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h4><p>任何进程默认就会启动一个线程，我们把它称为主线程。</p>
<p>使用threading开启新线程，threading.Thread(target=loop,name=’’)</p>
<h6 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h6><p>多进程中，同一个变量，各自有一份拷贝存在每个进程中，互不影响。而多线程中，所有变量都由线程共享，故而任何一个变量都可以被任何一个线程修改。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lock = threading.Lock()</span><br><span class="line">lock.acquire()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	do something</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">	lock.release()</span><br></pre></td></tr></table></figure>
<p>Python线程虽然是真正意义上的线程，但是解释器执行代码时，都会有一个GIL锁，</p>
<p>任何Python线程执行前，必须先获得GIL锁，然后执行100条字节码，解释器就自动释放GIL锁，让别的线程有机会执行。这个全局锁实际上把所有线程的执行代码都给上了锁，所以，即使跑在100核的CPU上，也只能用到1个核</p>
<blockquote>
<p>GIL Global Interpreter Lock</p>
</blockquote>
<h6 id="Threadlocal"><a href="#Threadlocal" class="headerlink" title="Threadlocal"></a>Threadlocal</h6><p>同java中的threadlocal</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local_school = threading.local()</span><br><span class="line">local_school.student</span><br></pre></td></tr></table></figure>
<h4 id="进程和线程比较"><a href="#进程和线程比较" class="headerlink" title="进程和线程比较"></a>进程和线程比较</h4><p>多进程<strong>稳定性高</strong>，一个子进程崩溃了不会影响其他进程。但是创建进程的<strong>代价大</strong></p>
<p>多线程<strong>速度快</strong>一些，但是任何一个线程挂掉都可能直接造成整个代码<strong>崩溃</strong>，因为所有线程共享进程的内存。比如Windows上的“该程序执行了非法操作，即将关闭”，往往是某个线程出了问题，但是操作系统会强制结束整个进程。</p>
<p>切换是有代价的，多任务一旦多到一个限度，就会消耗掉系统所有的资源，结果效率急剧下降。</p>
<ul>
<li>保存现场（CPU寄存器状态，内存页等）</li>
<li>准备新环境（恢复上次的寄存器状态，内存页等）</li>
</ul>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><table>
<thead>
<tr>
<th>表达</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>\d</td>
<td>num</td>
</tr>
<tr>
<td>\w</td>
<td>数字</td>
</tr>
<tr>
<td>.</td>
<td>任意一个字符</td>
</tr>
<tr>
<td>*</td>
<td>任意个字符（包括0个）</td>
</tr>
<tr>
<td>+</td>
<td>至少一个字符</td>
</tr>
<tr>
<td>？</td>
<td>0或1个字符</td>
</tr>
<tr>
<td>{n}</td>
<td>n个字符</td>
</tr>
<tr>
<td>{n,m}</td>
<td>n-m个字符</td>
</tr>
<tr>
<td>\s</td>
<td>空格</td>
</tr>
<tr>
<td>[]</td>
<td>表示范围，比如[0-9a-zA-Z_]</td>
</tr>
<tr>
<td>\</td>
<td>特殊符号需要在前面加\进行转义</td>
</tr>
<tr>
<td>A\</td>
<td>B</td>
<td>A或B</td>
</tr>
<tr>
<td>^</td>
<td>行的开头，^\d表示以数字开头</td>
</tr>
<tr>
<td>$</td>
<td>结尾，\d$表示以数字结尾</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">'ABC\\-001'</span></span><br><span class="line"><span class="comment"># 可以使用r前缀，这样就不用考虑转义了</span></span><br><span class="line">s = <span class="string">r'ABC\-001'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#python使用re库进行正则匹配</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">re.match(pattern,str)</span><br><span class="line"><span class="comment">#成功返回一个Match对象，否则返回None</span></span><br><span class="line"><span class="keyword">if</span> re.match(XX,str):</span><br><span class="line">    print(<span class="string">'OK'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'Fail'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 提取子串，用()表示的就是要提取的分组</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.match(<span class="string">r'^(\d&#123;3&#125;)-(\d&#123;3,8&#125;)$'</span>, <span class="string">'010-12345'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m</span><br><span class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">9</span>), match=<span class="string">'010-12345'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">0</span>)</span><br><span class="line"><span class="string">'010-12345'</span></span><br><span class="line"><span class="comment"># 在Match对象上用group()方法提取出自串</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">1</span>)</span><br><span class="line"><span class="string">'010'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">2</span>)</span><br><span class="line"><span class="string">'12345'</span></span><br></pre></td></tr></table></figure>
<p>python中的正则匹配采用的是贪婪算法，若需要采用非贪婪算法，需要在后面加一个？</p>
<p>比如\d+?</p>
<h3 id="网络编程"><a href="#网络编程" class="headerlink" title="网络编程"></a>网络编程</h3><h4 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h4><h5 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">s.connect((<span class="string">'www.sina.com.cn'</span>,<span class="number">80</span>))</span><br><span class="line">s.send(<span class="string">b'GET / HTTP/1.1\r\nHost: www.sina.com.cn\r\nConnection: close\r\n\r\n'</span>)</span><br><span class="line">buffer = []</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">	d = s.recv(<span class="number">1024</span>)</span><br><span class="line">	<span class="keyword">if</span> d:</span><br><span class="line">		buffer.append(d)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">data = <span class="string">b''</span>.join(buffer)</span><br><span class="line">s.close()</span><br><span class="line"></span><br><span class="line">header,html = data.split(<span class="string">b'\r\n\r\n'</span>,<span class="number">1</span>)</span><br><span class="line">print(header.decode(<span class="string">'utf-8'</span>))</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'sina.html'</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">	f.write(html)</span><br></pre></td></tr></table></figure>
<h5 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tcplink</span><span class="params">(sock, addr)</span>:</span></span><br><span class="line">    print(<span class="string">'Accept new connection from %s:%s...'</span> % addr)</span><br><span class="line">    sock.send(<span class="string">b'Welcome!'</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> data.decode(<span class="string">'utf-8'</span>) == <span class="string">'exit'</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sock.send((<span class="string">'Hello, %s!'</span> % data.decode(<span class="string">'utf-8'</span>)).encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    sock.close()</span><br><span class="line">    print(<span class="string">'Connection from %s:%s closed.'</span> % addr)</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.bind((<span class="string">'127.0.0.1'</span>,<span class="number">9999</span>))</span><br><span class="line">s.listen(<span class="number">5</span>)</span><br><span class="line">print(<span class="string">'Waiting for connection...'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="comment"># 接受一个新连接:</span></span><br><span class="line">    sock, addr = s.accept()</span><br><span class="line">    <span class="comment"># 创建新线程来处理TCP连接:</span></span><br><span class="line">    t = threading.Thread(target=tcplink, args=(sock, addr))</span><br><span class="line">    t.start()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 配套的客户端</span></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"><span class="comment"># 建立连接:</span></span><br><span class="line">s.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>))</span><br><span class="line"><span class="comment"># 接收欢迎消息:</span></span><br><span class="line">print(s.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line"><span class="keyword">for</span> data <span class="keyword">in</span> [<span class="string">b'Michael'</span>, <span class="string">b'Tracy'</span>, <span class="string">b'Sarah'</span>]:</span><br><span class="line">    <span class="comment"># 发送数据:</span></span><br><span class="line">    s.send(data)</span><br><span class="line">    print(s.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">s.send(<span class="string">b'exit'</span>)</span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure>
<h4 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h4><p>无连接协议，只需要知道对方的IP和端口号，就可以发送数据包，但是无法确认是否到达。</p>
<p>速度快，但传输数据不可靠。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server</span></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line"><span class="comment"># 绑定端口:</span></span><br><span class="line">s.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>))</span><br><span class="line">print(<span class="string">'Bind UDP on 9999...'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="comment"># 接收数据:</span></span><br><span class="line">    data, addr = s.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    print(<span class="string">'Received from %s:%s.'</span> % addr)</span><br><span class="line">    s.sendto(<span class="string">b'Hello, %s!'</span> % data, addr)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Client</span></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line"><span class="keyword">for</span> data <span class="keyword">in</span> [<span class="string">b'Michael'</span>, <span class="string">b'Tracy'</span>, <span class="string">b'Sarah'</span>]:</span><br><span class="line">    <span class="comment"># 发送数据:</span></span><br><span class="line">    s.sendto(data, (<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>))</span><br><span class="line">    <span class="comment"># 接收数据:</span></span><br><span class="line">    print(s.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><h4 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h4><p>轻量级，可嵌入，但是不能承受高并发访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入SQLite驱动:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="comment"># 连接到SQLite数据库</span></span><br><span class="line"><span class="comment"># 数据库文件是test.db</span></span><br><span class="line"><span class="comment"># 如果文件不存在，会自动在当前目录创建:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>conn = sqlite3.connect(<span class="string">'test.db'</span>)</span><br><span class="line"><span class="comment"># 创建一个Cursor:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor = conn.cursor()</span><br><span class="line"><span class="comment"># 执行一条SQL语句，创建user表:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor.execute(<span class="string">'create table user (id varchar(20) primary key, name varchar(20))'</span>)</span><br><span class="line">&lt;sqlite3.Cursor object at <span class="number">0x10f8aa260</span>&gt;</span><br><span class="line"><span class="comment"># 继续执行一条SQL语句，插入一条记录:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor.execute(<span class="string">'insert into user (id, name) values (\'1\', \'Michael\')'</span>)</span><br><span class="line">&lt;sqlite3.Cursor object at <span class="number">0x10f8aa260</span>&gt;</span><br><span class="line"><span class="comment"># 通过rowcount获得插入的行数:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor.rowcount</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="comment"># 关闭Cursor:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor.close()</span><br><span class="line"><span class="comment"># 提交事务:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>conn.commit()</span><br><span class="line"><span class="comment"># 关闭Connection:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>conn.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>conn = sqlite3.connect(<span class="string">'test.db'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor = conn.cursor()</span><br><span class="line"><span class="comment"># 执行查询语句:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor.execute(<span class="string">'select * from user where id=?'</span>, (<span class="string">'1'</span>,))</span><br><span class="line">&lt;sqlite3.Cursor object at <span class="number">0x10f8aa340</span>&gt;</span><br><span class="line"><span class="comment"># 获得查询结果集:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>values = cursor.fetchall()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>values</span><br><span class="line">[(<span class="string">'1'</span>, <span class="string">'Michael'</span>)]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor.close()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>conn.close()</span><br></pre></td></tr></table></figure>
<h4 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h4><p>为服务器端设计的数据库，能承受高并发访问，占用内存页高</p>
<p>内部有多种数据库引擎，最常用的是支持数据库事务的InnoDB</p>
<h3 id="异步IO"><a href="#异步IO" class="headerlink" title="异步IO"></a>异步IO</h3><p>当代码需要执行一个耗时的IO操作时，并不等待IO结果，然后就去执行其他代码了。一段时间后，当IO返回结果时，再通知CPU进行处理</p>
<p>  一般采用一个消息循环，主线程不断的重复“读取消息-处理消息”这一过程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">loop = get_event_loop()</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    event = loop.get_event()</span><br><span class="line">    process_event(event)</span><br></pre></td></tr></table></figure>
<h4 id="Coroutine-协程"><a href="#Coroutine-协程" class="headerlink" title="Coroutine 协程"></a>Coroutine 协程</h4><p>Coroutine看上去也是函数，但在执行过程中，可以中断，然后执行别的函数，在适当的时候再回来接着执行。</p>
<p>看起来像多线程，但实际上在同一个线程中运行，运行效率极高，且不需要多线程的锁机制。</p>
<p>Python对coroutine的支持是通过generator实现的。Python的yield不但可以返回一个值，还可以接收调用者发出的参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></span><br><span class="line">    r = <span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 通过yield拿到消息，处理，并返回</span></span><br><span class="line">        n = <span class="keyword">yield</span> r</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        print(<span class="string">'[CONSUMER] Consuming %s...'</span> % n)</span><br><span class="line">        r = <span class="string">'200 OK'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">produce</span><span class="params">(c)</span>:</span></span><br><span class="line">    <span class="comment"># 启动生成器</span></span><br><span class="line">    c.send(<span class="keyword">None</span>)</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="number">5</span>:</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">        print(<span class="string">'[PRODUCER] Producing %s...'</span> % n)</span><br><span class="line">        r = c.send(n)</span><br><span class="line">        print(<span class="string">'[PRODUCER] Consumer return: %s'</span> % r)</span><br><span class="line">    c.close()</span><br><span class="line"></span><br><span class="line">c = consumer()</span><br><span class="line">produce(c)</span><br></pre></td></tr></table></figure>
<h4 id="asyncio-async-await"><a href="#asyncio-async-await" class="headerlink" title="asyncio(async await)"></a>asyncio(async await)</h4><p>asyncio就是一个消息循环，从asyncio模块中直接获取一个EventLoop的引用，然后把需要执行的协程扔到EventLoop中执行，就实现了异步IO。</p>
<p>同一个线程并发执行两个coroutine</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="comment"># 简化为async def hello()</span></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Hello world! (%s)'</span> % threading.currentThread())</span><br><span class="line">    <span class="comment"># 简化为 await asyncio.sleep(1)</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'Hello again! (%s)'</span> % threading.currentThread())</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">tasks = [hello(), hello()]</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hgworts.tech/2017/02/10/Cpp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hgDendi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HgWorts">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/10/Cpp/" itemprop="url">Cpp</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-10T00:00:00+08:00">
                2017-02-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C++</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>cpp对函数之间的的排列要满足先定义后使用。后定义先调用的函数必须声明。因为在函数被调用之前，应当让编译器知道该函数的原型。</p>
<h2 id="内存区域"><a href="#内存区域" class="headerlink" title="内存区域"></a>内存区域</h2><ul>
<li>代码区<ul>
<li>存放程序的可执行代码</li>
</ul>
</li>
<li>全局数据区<ul>
<li>静态变量</li>
<li>一般的全局变量（自动初始化为0）</li>
</ul>
</li>
<li>栈区<ul>
<li>局部变量（不处理原内存中的值）</li>
</ul>
</li>
<li>堆区<ul>
<li>与指针有关的动态数据</li>
</ul>
</li>
</ul>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>全局变量若和局部变量同名，需要加上:: </p>
<h4 id="static"><a href="#static" class="headerlink" title="static"></a>static</h4><p>static修饰的变量为静态变量、内部变量。其中局部静态变量具有局部作用域，但是却具有全局生存期。</p>
<p>static变量作为类的静态变量时，需要在类外部(.cpp)进行定义，如</p>
<p>float Stub::staticVariable=0;</p>
<p>静态函数成员的调用</p>
<p>Stub::stubmethod();</p>
<p>extern作用域从定义处到当前文件结束</p>
<p>默认参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void showArea(int a = 0,int b = 10)</span><br></pre></td></tr></table></figure>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><h5 id="函数模板"><a href="#函数模板" class="headerlink" title="函数模板"></a>函数模板</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class">  <span class="title">void</span> <span class="title">swap</span>(<span class="title">T</span> &amp;<span class="title">left</span> , <span class="title">T</span> &amp;<span class="title">right</span>)&#123;</span></span><br><span class="line">    <span class="comment">//todo</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h5 id="类模板"><a href="#类模板" class="headerlink" title="类模板"></a>类模板</h5><p>编译器看到类模板时并不为它分配内存空间，直到定义了一个模板对象，即模板参数由编译器替换时，才为其分配空间。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt; <span class="class"><span class="keyword">class</span> <span class="title">T</span> &gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">Stub</span>&#123;</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Stub&lt;<span class="keyword">int</span>&gt; initStub;</span><br></pre></td></tr></table></figure>
<h3 id="内联函数"><a href="#内联函数" class="headerlink" title="内联函数"></a>内联函数</h3><p>一定要放在头文件中</p>
<p>方法是加上inline关键字</p>
<p>编译器在编译时，会将内联函数采用函数体进行替换，是以增加目标代码为代价来换取时间的。</p>
<h3 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回指针 </span></span><br><span class="line">float *search(float (*p)[4],int n)&#123;</span><br><span class="line">   <span class="keyword">return</span> *(p+n);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//一种错误情况，局部变量导致系统释放空间，使得返回的地址无效</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> name[<span class="number">81</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>void指针表示任何类型。但是不能对其使用算数操作。</p>
<p>const可以修饰类型、变量名</p>
<ul>
<li>修饰类型表示不可以通过指针改变现在所指的内容</li>
<li>修饰变量名，表示可以改变指针所指向空间的内容</li>
</ul>
<h3 id="Main"><a href="#Main" class="headerlink" title="Main"></a>Main</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="内存的动态分配和释放"><a href="#内存的动态分配和释放" class="headerlink" title="内存的动态分配和释放"></a>内存的动态分配和释放</h3><p>new和delete</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *iptr = <span class="keyword">new</span> <span class="keyword">int</span>;</span><br><span class="line"><span class="keyword">int</span> *iptr = <span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> *a;</span><br><span class="line">a = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">100</span>];</span><br><span class="line"><span class="comment">//若空间不足 new int会返回0或NULL</span></span><br><span class="line"><span class="keyword">if</span>(<span class="literal">NULL</span> == a)&#123;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//释放</span></span><br><span class="line"><span class="keyword">delete</span> a;</span><br><span class="line"><span class="keyword">delete</span> [] a;</span><br></pre></td></tr></table></figure>
<p>malloc和free</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NODE * NODE;</span><br><span class="line">NODE = (NODE*) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(NODE));</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(NODE);</span><br></pre></td></tr></table></figure>
<h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> NAME[<span class="number">100</span>];</span><br></pre></td></tr></table></figure>
<h3 id="类"><a href="#类" class="headerlink" title="类"></a>类</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stub</span>&#123;</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">  	<span class="keyword">int</span> a;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  	<span class="function"><span class="keyword">void</span> <span class="title">calculate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//类外部定义函数需要用两个引号</span></span><br><span class="line"><span class="keyword">void</span> stub::calculate()&#123;</span><br><span class="line">  	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新建类</span></span><br><span class="line"> Stub stub;</span><br></pre></td></tr></table></figure>
<h3 id="h文件和-cpp文件"><a href="#h文件和-cpp文件" class="headerlink" title=".h文件和.cpp文件"></a>.h文件和.cpp文件</h3><p>将类的定义存储在头文件中，函数成员放在cpp文件中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Rectangle.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> RECTANGLE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RECTANGLE_H</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setData</span><span class="params">(<span class="keyword">float</span>,<span class="keyword">float</span>)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">calculate</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">float</span> width;</span><br><span class="line">  <span class="keyword">float</span> height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Rectangle.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Rectangle.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Rectangle::setData(<span class="keyword">float</span> w,<span class="keyword">float</span> l)&#123;</span><br><span class="line">  width = w;</span><br><span class="line">  height = l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Rectangle::calculate()&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="友元函数"><a href="#友元函数" class="headerlink" title="友元函数"></a>友元函数</h3><p>友元函数不是类中的函数成员，但它可以访问类中定义的私有成员。</p>
<p>友元破坏了数据的封装和隐藏，尽量不使用或少适用友元。</p>
<h4 id="外部函数作为类的友元"><a href="#外部函数作为类的友元" class="headerlink" title="外部函数作为类的友元"></a>外部函数作为类的友元</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//类中定义</span></span><br><span class="line"><span class="function"><span class="keyword">friend</span> <span class="keyword">double</span> <span class="title">Distance</span><span class="params">(Point &amp;a,Point &amp;b)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//外部函数定义</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">Distance</span><span class="params">(Point &amp;a , Point &amp;b)</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="类的成员函数作为另一个类的友元"><a href="#类的成员函数作为另一个类的友元" class="headerlink" title="类的成员函数作为另一个类的友元"></a>类的成员函数作为另一个类的友元</h4><p>这样的成员函数也被称为友元成员。既可以访问所在类对象的私有成员，也可以访问friend声明语句所在类对象中的私有成员和公有成员。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Budget</span>&#123;</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">  	<span class="keyword">float</span> divBudget;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  	<span class="keyword">friend</span> <span class="keyword">void</span> Aux::addBudget(<span class="keyword">float</span> , Budget &amp;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Aux.cpp</span></span><br><span class="line"><span class="keyword">void</span> Aux::addBudget(<span class="keyword">float</span> , Budget &amp;)&#123;</span><br><span class="line">  divBudget++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="一个类作为另外一个类的友元"><a href="#一个类作为另外一个类的友元" class="headerlink" title="一个类作为另外一个类的友元"></a>一个类作为另外一个类的友元</h4><p>B类中的每个函数成员都能访问A类中的私有成员。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  	<span class="function"><span class="keyword">void</span> <span class="title">Display</span><span class="params">()</span></span>;</span><br><span class="line">  	<span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="拷贝构造函数"><a href="#拷贝构造函数" class="headerlink" title="拷贝构造函数"></a>拷贝构造函数</h3><p>并不调用构造函数，而是采用对象按位拷贝操作，将b对象的每个成员复制到a中。这样如果b中有指针，a中也会有指针，而a对象在析构的时候可能会删除指针指向的内容，导致b对象错乱。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stub a = b;</span><br></pre></td></tr></table></figure>
<p>拷贝构造函数是特殊的构造函数，当采用一个对象初始化另一个对象时，将自动调用该函数。</p>
<p>拷贝构造函数在<strong>对象被创建</strong>时调用，而赋值函数在对象<strong>已经存在</strong>的情况下调用。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stub</span>&#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  	Stub(<span class="keyword">const</span> Stub &amp;obj)&#123;</span><br><span class="line">      name = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="built_in">strlen</span>(obj.name)+<span class="number">1</span>];</span><br><span class="line">      <span class="built_in">strcpy</span>(name,obj.name);</span><br><span class="line">      age = obj.age;</span><br><span class="line">  	&#125;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">  	<span class="keyword">char</span> *name;</span><br><span class="line">  	<span class="keyword">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="操作符重载"><a href="#操作符重载" class="headerlink" title="操作符重载"></a>操作符重载</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stub</span>&#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  	<span class="keyword">void</span> <span class="keyword">operator</span> =(<span class="keyword">const</span> Stub &amp;right)&#123;</span><br><span class="line">    </span><br><span class="line">  	&#125;</span><br><span class="line">  </span><br><span class="line">  	Stub <span class="keyword">operator</span> ++();<span class="comment">//prefix</span></span><br><span class="line">  	Stub <span class="keyword">operator</span> ++(<span class="keyword">int</span>);<span class="comment">//post</span></span><br><span class="line">  	ostream &amp;<span class="keyword">operator</span> &lt;&lt;(ostream &amp;strm , Stub &amp;stub)&#123;</span><br><span class="line">      strm &lt;&lt;stub.XXX;</span><br><span class="line">      <span class="keyword">return</span> strm;</span><br><span class="line">  	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//类型转换</span></span><br><span class="line">  	<span class="function"><span class="keyword">operator</span> <span class="title">float</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">12.0</span>;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h3><p>创建一个临时对象将其返回 和 创建一个局部变量并返回 是不同的。</p>
<p>场景1：</p>
<ol>
<li>创建一个temp对象，调用构造函数完成初始化；</li>
<li>拷贝构造函数将temp赋值到内存的外部存储中；</li>
<li>在函数结束时，摧毁temp对象</li>
</ol>
<p>而场景2：直接把临时对象创建并初始化在内存的外部存储单元中，省去了调用拷贝构造函数和析构函数的过程，提高了效率。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">temp</span><span class="params">(s1+s2)</span></span>;</span><br><span class="line"><span class="keyword">return</span> temp;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">string</span>(s1+s2);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>和<span class="number">2</span></span><br></pre></td></tr></table></figure>
<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>CPP可以多重继承，其中子类的同名函数需要作用域分隔符：：来确定要调用的函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Son</span> :</span> <span class="keyword">public</span> Father &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">Son::Son(<span class="built_in">string</span> name):Father(name)</span><br><span class="line"></span><br><span class="line"><span class="comment">//public、protected、private为继承修饰符，控制可见性。</span></span><br></pre></td></tr></table></figure>
<h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">divide</span><span class="params">(<span class="keyword">int</span> dividend , <span class="keyword">int</span> divisor)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(divisor == <span class="number">0</span> )&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">"error"</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">float</span> (dividend)/divisor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  divide(a,b);</span><br><span class="line">&#125;<span class="keyword">catch</span>(<span class="keyword">char</span>* exceptionString)&#123;</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; exceptionString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="初始化列表"><a href="#初始化列表" class="headerlink" title="初始化列表"></a>初始化列表</h4><p>构造函数参数表和函数体之间，在构造函数的函数体执行之前完成初始化列表中指定的工作。</p>
<ol>
<li>具有继承关系的子类必须在初始化列表中调用基类的构造函数</li>
<li>类中的const常量成员只能在初始化列表中进行初始化</li>
<li>对象类型的成员的初始化放在初始化列表中则程序的效率较高</li>
</ol>
<h3 id="Virtual"><a href="#Virtual" class="headerlink" title="Virtual"></a>Virtual</h3><p>CPP编译器在默认情况下，对函数成员的调用实施的是静态绑定。如需改为动态绑定，需要增加前缀virtual</p>
<p>虚函数是一个函数成员，唯一要求是在子类中一定要覆盖它。</p>
<h5 id="纯虚函数"><a href="#纯虚函数" class="headerlink" title="纯虚函数"></a>纯虚函数</h5><p>virtual &lt;&gt; &lt;&gt;() = 0; </p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>CPP中字符串末尾要有\0</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hgworts.tech/2017/01/16/Java类的生命周期/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hgDendi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HgWorts">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/16/Java类的生命周期/" itemprop="url">Java类的生命周期</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-16T00:00:00+08:00">
                2017-01-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h2 id="重要内存区域"><a href="#重要内存区域" class="headerlink" title="重要内存区域"></a>重要内存区域</h2><h3 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h3><p>运行时常量池、字段和方法信息、静态变量等数据。</p>
<blockquote>
<p>已经加载的类信息、常量、静态变量以及方法代码的内存区域</p>
</blockquote>
<h3 id="堆区"><a href="#堆区" class="headerlink" title="堆区"></a>堆区</h3><p>Java堆用来存放对象实例，几乎所有的对象实例都在这里分配内存。Java堆存储的对象被垃圾收集器管理，这些受管理的对象无需也无法显式的销毁。</p>
<p>从内存回收的角度，Java堆可以粗略的分为新生代和老年代。从内存分配的角度Java堆中可能划分出多个线程私有的分配缓冲区。不管如何划分，Java堆存储的内容是不变的，进行划分是为了能更快的回收或者分配内存。</p>
<h4 id="对象在堆内存的布局"><a href="#对象在堆内存的布局" class="headerlink" title="对象在堆内存的布局"></a>对象在堆内存的布局</h4><ul>
<li>对象头<ul>
<li>MarkWorld，用于存储对象运行时的数据，如hashcode，锁状态标志，GC分代年龄等</li>
<li>元数据，指向方法区中目标类的类型信息，通过元数据指针确定对象的具体类型</li>
</ul>
</li>
<li>实例数据<ul>
<li>存储对象中的各种类型的字段信息</li>
</ul>
</li>
<li>用于对齐的padding</li>
</ul>
<h3 id="Java虚拟机栈"><a href="#Java虚拟机栈" class="headerlink" title="Java虚拟机栈"></a>Java虚拟机栈</h3><p>每一条Java虚拟机线程都有一个线程私有的Java虚拟机栈（Java Virtual Machine Stacks)。它的生命周期与线程相同，与线程是同时创建的。</p>
<p>存储线程中Java方法调用的状态，包括局部变量、参数、返回值以及运算的中间结果等。一个Java虚拟机栈包含了多个栈帧，一个栈帧用来存储局部变量表、操作数栈、动态链接、方法出口等信息。当线程调用一个Java方法时，虚拟机压入一个新的栈帧到该线程的Java栈中，当该方法执行完成，这个栈帧就从Java栈中弹出。我们平常所说的栈内存（Stack）指的就是Java虚拟机栈。</p>
<h3 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h3><p>支持Native方法，与JVM栈相似</p>
<h3 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h3><p>为了保证程序能够连续地执行下去，处理器必须具有某些手段来确定下一条指令的地址，而程序计数器正是起到这种作用。</p>
<h3 id="运行时数据区域"><a href="#运行时数据区域" class="headerlink" title="运行时数据区域"></a>运行时数据区域</h3><h4 id="线程隔离"><a href="#线程隔离" class="headerlink" title="线程隔离"></a>线程隔离</h4><ol>
<li>Program Counter Register 程序计数器</li>
<li>JVM Stacks 虚拟机栈</li>
<li>Native  Stack</li>
</ol>
<h4 id="线程共享"><a href="#线程共享" class="headerlink" title="线程共享"></a>线程共享</h4><ol>
<li>Java Heap 堆<ol>
<li>是java虚拟机所管理的内存中最大的一块，用来存放对象实例</li>
<li>可以处于物理上不连续的内存空间中，只要逻辑上是连续的即可</li>
<li>可用过-Xmx和-Xms控制</li>
</ol>
</li>
<li>Method Area 方法区<ol>
<li>存储加载过的类信息、常量、静态变量、即时编译器编译后的代码等数据</li>
<li>别名为Non-Heap（非堆），是PermentGeneration永久代</li>
<li>包含运行时常量池，用于存放各种字面量和符号引用，不要求常量只有编译器才能产生，比如String的intern</li>
</ol>
</li>
</ol>
<h2 id="类的生命周期"><a href="#类的生命周期" class="headerlink" title="类的生命周期"></a>类的生命周期</h2><p><img src="https://ww1.sinaimg.cn/large/006tKfTcgw1fbsu1u9npoj31060j60uq.jpg" alt="Screen Shot 2017-01-16 at 20.38.17"></p>
<h3 id="Loading-加载"><a href="#Loading-加载" class="headerlink" title="Loading 加载"></a>Loading 加载</h3><blockquote>
<p>找到需要加载的类并把类的信息加载到方法区中，然后在堆区中实例化一个Class对象，作为方法区中这个类的信息的入口</p>
</blockquote>
<ol>
<li>根据类的全名，生成一份二进制的字节码</li>
<li>将字节码解析成方法区对应的数据结构</li>
<li>生成Class对象的实例表示该类</li>
</ol>
<h3 id="Linking-连接"><a href="#Linking-连接" class="headerlink" title="Linking 连接"></a>Linking 连接</h3><p>不一定要等到加载完成后，有时可以<strong>同时执行</strong>（比如Loading和Verification可以同时执行）</p>
<h4 id="Verification"><a href="#Verification" class="headerlink" title="Verification"></a>Verification</h4><p>保证类符合Java的语法规范。</p>
<p>比如：bytecode的完整性、final方法的检查、方法签名的检查</p>
<h4 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h4><p>JVM为类的成员变量分配内存空间并且赋予默认初始值，需要注意的是这个阶段不会执行任何代码，而<strong>只是根据变量类型决定初始值</strong>。即所有int赋值为0，代码中的初始化赋值不进行运行。</p>
<p>也可能会为有助于提高程序性能的数据结构分配内存，比如method table。</p>
<p>method table这个数据结构包含了指向所有类方法的指针（包括从父类集成的方法）</p>
<h4 id="Resulotion"><a href="#Resulotion" class="headerlink" title="Resulotion"></a>Resulotion</h4><p>确认类、接口、属性和方法在类的<strong>run-time constant pool</strong>的位置，并且把这些符号引用替换为直接引用。</p>
<p>symbolic references ==》 direct reference</p>
<p><img src="https://ww4.sinaimg.cn/large/006tKfTcgw1fbsu1u11g3j314i0n641d.jpg" alt="Screen Shot 2017-01-16 at 20.55.10"></p>
<h3 id="Initialization-初始化"><a href="#Initialization-初始化" class="headerlink" title="Initialization 初始化"></a>Initialization 初始化</h3><blockquote>
<p>如果一个类<strong>第一次</strong>被<strong>直接引用</strong>，就会触发类的初始化</p>
<p>在此之前会先触发父类的初始化</p>
</blockquote>
<h4 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h4><p>会按照代码书写顺序进行初始化，但总体规则是</p>
<ol>
<li>static先于非static</li>
<li>显式初始化，构造块初始化，最后调用构造函数进行初始化</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton mInstance = <span class="keyword">new</span> Singleton();<span class="comment">// 位置1，输出1，0</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> counter1;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> counter2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    private static Singleton mInstance = new Singleton();// 位置2，输出1，1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        counter1++;</span><br><span class="line">        counter2++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstantce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Singleton singleton = Singleton.getInstantce();</span><br><span class="line">        System.out.println(<span class="string">"counter1: "</span> + singleton.counter1);</span><br><span class="line">        System.out.println(<span class="string">"counter2: "</span> + singleton.counter2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="直接引用"><a href="#直接引用" class="headerlink" title="直接引用"></a>直接引用</h4><ol>
<li>创建实例（new、反射、cloning、反序列化）</li>
<li>调用类的static方法</li>
<li>使用或对类、接口的static属性进行赋值（<strong>不包括final</strong>的与在编译器确定的常量表达式，如果使用的父类的静态变量，则只需要加载父类即可）</li>
<li>调用API中的某些反射方法</li>
<li>子类被初始化</li>
<li>具有main方法的类</li>
</ol>
<h4 id="被动使用"><a href="#被动使用" class="headerlink" title="被动使用"></a>被动使用</h4><ol>
<li>引用父类的静态字段，只会引起父类的初始化，不会引起子类的初始化</li>
<li>定义类数组，不会引起类的初始化</li>
<li>引用类的常量，不会引起类的初始化</li>
</ol>
<h4 id="Unloading-卸载"><a href="#Unloading-卸载" class="headerlink" title="Unloading 卸载"></a>Unloading 卸载</h4><blockquote>
<p>满足下面的情况，类就会被卸载</p>
</blockquote>
<ul>
<li>该类所有的实例都已经被回收，也就是java堆中不存在该类的任何实例</li>
<li>加载该类的ClassLoader已经被回收</li>
<li>该类对应的java.lang.Class对象没有任何地方被引用，无法再任何地方通过反射访问该类的方法</li>
</ul>
<h2 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h2><p>程序在启动的时候，并不会一次性加载所有要用的class文件，而是根据程序的需要，通过Java的类加载机制来动态加载某个class文件到内存当中的，从而只有class文件被载入到了内存之后，才能被其他class文件所引用。所以ClassLoader就是用来动态加载class文件到内存当中的。</p>
<h3 id="Bootstrap-ClassLoader"><a href="#Bootstrap-ClassLoader" class="headerlink" title="Bootstrap ClassLoader"></a>Bootstrap ClassLoader</h3><h3 id="Extension-ClassLoader"><a href="#Extension-ClassLoader" class="headerlink" title="Extension ClassLoader"></a>Extension ClassLoader</h3><h3 id="App-ClassLoader"><a href="#App-ClassLoader" class="headerlink" title="App ClassLoader"></a>App ClassLoader</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="hgDendi" />
          <p class="site-author-name" itemprop="name">hgDendi</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/hgDendi" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/hgdendi" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hgDendi</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
